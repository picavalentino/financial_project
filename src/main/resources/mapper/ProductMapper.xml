<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE  mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.team.financial_project.mapper.ProductMapper">
    <resultMap id="ProductResultMap" type="com.team.financial_project.product.dto.ProductDTO">
        <!-- ProductDTO 기본 필드 -->
        <id property="prodSn" column="prod_sn" />
        <result property="prodNm" column="prod_nm" />
        <result property="prodInstlAmtMin" column="prod_instl_amt_min" />
        <result property="prodInstlAmtMax" column="prod_instl_amt_max" />
        <result property="prodCreateAt" column="prod_create_at" />
        <result property="prodUpdateAt" column="prod_update_at" />
        <result property="userId" column="user_id" />
        <result property="prodCd" column="prod_cd" />
        <result property="prodTyCd" column="prodTyCd" />
        <result property="prodSbstgTyCd" column="prodSbstgTyCd" />
        <result property="prodPayTyCd" column="prodPayTyCd" />
        <result property="prodAirMin" column="prod_air_min" />
        <result property="prodAirMax" column="prod_air_max" />
        <result property="prodAirBgnYmd" column="prod_air_bgn_ymd" />
        <result property="prodAirEndYmd" column="prod_air_end_ymd" />
        <result property="prodIntTaxTyCd" column="prodIntTaxTyCd" />
        <result property="prodCurrStcd" column="prodCurrStcd" />
        <result property="prodNtslBgnYmd" column="prod_ntsl_bgn_ymd" />
        <result property="prodNtslEndYmd" column="prod_ntsl_end_ymd" />

        <!-- prodHist 리스트 매핑 -->
        <collection property="histList" ofType="com.team.financial_project.product.dto.ProdHistDTO">
            <id property="histId" column="hist_id" />
            <result property="userId" column="user_id" />
            <result property="prodSn" column="prod_sn" />
            <result property="prodAirMin" column="hist_prod_air_min" />
            <result property="prodAirMax" column="hist_prod_air_max" />
            <result property="prodAirBgnYmd" column="hist_prod_air_bgn_ymd" />
            <result property="prodAirEndYmd" column="hist_prod_air_end_ymd" />
            <result property="histCreateAt" column="hist_create_at" />
            <result property="histCurrStcd" column="hist_curr_stcd" />
        </collection>
    </resultMap>

    <select id="findAll" resultType="com.team.financial_project.product.dto.ProductDTO">
        SELECT
        p.prod_sn,
        p.prod_nm,
        p.prod_instl_amt_min,
        p.prod_instl_amt_max,
        p.prod_create_at,
        p.prod_update_at,
        p.user_id,
        p.prod_cd,
        c1.code_nm AS prodTyCd,
        c2.code_nm AS prodSbstgTyCd,
        c3.code_nm AS prodPayTyCd,
        c4.code_nm AS prodIntTaxTyCd,
        p.prod_air_min,
        p.prod_air_max,
        p.prod_air_bgn_ymd,
        p.prod_air_end_ymd,
        p.prod_curr_stcd,
        p.prod_ntsl_bgn_ymd,
        p.prod_ntsl_end_ymd
        FROM tb_product p
        LEFT JOIN tb_code c1 ON c1.code_cl = p.prod_ty_cd_code_cl AND c1.code_no = p.prod_ty_cd
        LEFT JOIN tb_code c2 ON c2.code_cl = p.prod_sbstg_ty_cd_code_cl AND c2.code_no = p.prod_sbstg_ty_cd
        LEFT JOIN tb_code c3 ON c3.code_cl = p.prod_pay_ty_cd_code_cl AND c3.code_no = p.prod_pay_ty_cd
        LEFT JOIN tb_code c4 ON c4.code_cl = p.prod_int_tax_ty_cd_code_cl AND c4.code_no = p.prod_int_tax_ty_cd
        ORDER BY p.prod_create_at DESC;
    </select>

    <select id="findById" parameterType="Long" resultMap="ProductResultMap">
        SELECT
        p.prod_sn,
        p.prod_nm,
        p.prod_instl_amt_min,
        p.prod_instl_amt_max,
        p.prod_create_at,
        p.prod_update_at,
        p.user_id,
        p.prod_cd,
        c1.code_nm AS prodTyCd,
        c2.code_nm AS prodSbstgTyCd,
        c3.code_nm AS prodPayTyCd,
        c4.code_nm AS prodIntTaxTyCd,
        p.prod_air_min,
        p.prod_air_max,
        p.prod_air_bgn_ymd,
        p.prod_air_end_ymd,
        c5.code_nm AS prodCurrStcd,
        p.prod_ntsl_bgn_ymd,
        p.prod_ntsl_end_ymd,
        h.hist_id,
        h.user_id,
        h.prod_sn,
        h.hist_prod_air_min,
        h.hist_prod_air_max,
        h.hist_prod_air_bgn_ymd,
        h.hist_prod_air_end_ymd,
        h.hist_create_at,
        h.hist_curr_stcd
        FROM tb_product p
        LEFT JOIN tb_code c1 ON c1.code_cl = p.prod_ty_cd_code_cl AND c1.code_no = p.prod_ty_cd
        LEFT JOIN tb_code c2 ON c2.code_cl = p.prod_sbstg_ty_cd_code_cl AND c2.code_no = p.prod_sbstg_ty_cd
        LEFT JOIN tb_code c3 ON c3.code_cl = p.prod_pay_ty_cd_code_cl AND c3.code_no = p.prod_pay_ty_cd
        LEFT JOIN tb_code c4 ON c4.code_cl = p.prod_int_tax_ty_cd_code_cl AND c4.code_no = p.prod_int_tax_ty_cd
        LEFT JOIN tb_code c5 ON c5.code_cl = p.prod_curr_stcd_code_cl AND c5.code_no = p.prod_curr_stcd
        LEFT JOIN tb_prod_hist h ON h.prod_sn = p.prod_sn
        WHERE p.prod_sn = #{prodSn}
    </select>

    <insert id="insertProduct" parameterType="com.team.financial_project.product.dto.ProductDTO">

    </insert>

    <update id="updateProduct" parameterType="com.team.financial_project.product.dto.ProductDTO">
        <!-- 기존 데이터를 tb_prod_hist 테이블에 추가 -->
        INSERT INTO tb_prod_hist (
        hist_id,
        prod_sn,
        hist_prod_air_min,
        hist_prod_air_max,
        hist_prod_air_bgn_ymd,
        hist_prod_air_end_ymd,
        hist_create_at
        )
        SELECT
        nextval('tb_prod_hist_hist_id_seq'),
        prod_sn,
        prod_air_min,
        prod_air_max,
        prod_air_bgn_ymd,
        prod_air_end_ymd,
        now()
        FROM tb_product
        WHERE prod_sn = #{prodSn};

        <!-- tb_product에 새로운 데이터 업데이트 -->
        UPDATE tb_product
        SET
        prod_air_min = #{prodAirMin},
        prod_air_max = #{prodAirMax},
        prod_air_bgn_ymd = #{prodAirBgnYmd},
        prod_air_end_ymd = #{prodAirEndYmd},
        prod_ntsl_bgn_ymd = #{prodNtslBgnYmd},
        prod_ntsl_end_ymd = #{prodNtslEndYmd},
        prod_update_at = now()
        WHERE prod_sn = #{prodSn};
    </update>

    <update id="deleteProduct" parameterType="java.math.BigDecimal">
        UPDATE tb_product
        SET prod_curr_stcd = 2
        WHERE prod_sn = #{prodSn}
    </update>

</mapper>