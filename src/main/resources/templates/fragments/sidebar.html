<!DOCTYPE html>
<html xmlns:th="www.thymeleaf.org">
<!-- sidebar라는 이름으로 선언-->
<div th:fragment="sidebar" class="sidebar">
    <div class="sidebar-sticky">
        <div class="container">
            <!-- 사용자 프로필 -->
            <div class="profile text-center mb-4">
                <a th:href="@{/customer/list}"><img src="/images/common/profile.png" alt="User Profile" class="img-fluid" id="userProfileImage"></a>
                <h4 id="userProfileName">000 님</h4>
            </div>

            <!-- 사이드바 메뉴 -->
            <ul class="nav flex-column">
                <li class="nav-item">
                    <div class="dropdown">
                        <button class="btn btn-link dropdown-toggle" type="button" id="dropdownMenuButton1" data-bs-toggle="collapse" data-bs-target="#customerManagement" aria-expanded="false" aria-controls="customerManagement">
                            <img src="/images/common/고객관리.png" class="img-menuicon">
                            고객관리
                        </button>
                        <div class="collapse" id="customerManagement">
                            <ul class="list-unstyled">
                                <li class="d-flex justify-content-between align-items-center">
                                    <a th:href="@{/customer/list}">고객 목록</a>
                                    <a href="javascript:void(0);" class="ml-auto bookmark-btn" data-menu-id="5">
                                        <img src="/images/common/pin_no.png" class="img-pin">
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </li>
                <li class="nav-item">
                    <div class="dropdown">
                        <button class="btn btn-link dropdown-toggle" type="button" id="dropdownMenuButton2" data-bs-toggle="collapse" data-bs-target="#productManagement" aria-expanded="false" aria-controls="productManagement">
                            <img src="/images/common/상품관리.png" class="img-menuicon">
                            상품 관리
                        </button>
                        <div class="collapse" id="productManagement">
                            <ul class="list-unstyled">
                                <li class="d-flex justify-content-between align-items-center">
                                    <a th:href="@{/product/list}">상품 목록 조회</a>
                                    <a href="javascript:void(0);" class="ml-auto bookmark-btn" data-menu-id="6">
                                        <img src="/images/common/pin_no.png" class="img-pin">
                                    </a>
                                </li>
                                <li class="d-flex justify-content-between align-items-center">
                                    <a th:href="@{/product/insert}">신규 상품 등록</a>
                                    <a href="javascript:void(0);" class="ml-auto bookmark-btn" data-menu-id="7">
                                        <img src="/images/common/pin_no.png" class="img-pin">
                                    </a>
                                </li>
                                <li class="d-flex justify-content-between align-items-center">
                                    <a th:href="@{/product/sales}">매출 조회</a>
                                    <a href="javascript:void(0);" class="ml-auto bookmark-btn" data-menu-id="8">
                                        <img src="/images/common/pin_no.png" class="img-pin">
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </li>
                <li class="nav-item">
                    <div class="dropdown">
                        <button class="btn btn-link dropdown-toggle" type="button" id="dropdownMenuButton3" data-bs-toggle="collapse" data-bs-target="#eventManagement" aria-expanded="false" aria-controls="eventManagement">
                            <img src="/images/common/활동관리.png" class="img-menuicon">
                            활동 관리
                        </button>
                        <div class="collapse" id="eventManagement">
                            <ul class="list-unstyled">
                                <li class="d-flex justify-content-between align-items-center">
                                    <a th:href="@{/schedule/personal}">개인 일정 관리</a>
                                    <a href="javascript:void(0);" class="ml-auto bookmark-btn" data-menu-id="9">
                                        <img src="/images/common/pin_no.png" class="img-pin">
                                    </a>
                                </li>
                                <li class="d-flex justify-content-between align-items-center">
                                    <a th:href="@{/schedule/customer}">고객 이벤트 관리</a>
                                    <a href="javascript:void(0);" class="ml-auto bookmark-btn" data-menu-id="10">
                                        <img src="/images/common/pin_no.png" class="img-pin">
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </li>
                <li class="nav-item">
                    <div class="dropdown">
                        <button class="btn btn-link dropdown-toggle" type="button" id="dropdownMenuButton4" data-bs-toggle="collapse" data-bs-target="#promotionManagement" aria-expanded="false" aria-controls="promotionManagement">
                            <img src="/images/common/프로모션관리.png" class="img-menuicon">
                            프로모션 관리
                        </button>
                        <div class="collapse" id="promotionManagement">
                            <ul class="list-unstyled">
                                <li class="d-flex justify-content-between align-items-center">
                                    <a th:href="@{/promotion/list}">상품 설계 조회</a>
                                    <a href="javascript:void(0);" class="ml-auto bookmark-btn" data-menu-id="11">
                                        <img src="/images/common/pin_no.png" class="img-pin">
                                    </a>
                                </li>
                                <li class="d-flex justify-content-between align-items-center">
                                    <a th:href="@{/promotion/cal}">금융 계산기</a>
                                    <a href="javascript:void(0);" class="ml-auto bookmark-btn" data-menu-id="12">
                                        <img src="/images/common/pin_no.png" class="img-pin">
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </li>
                <li class="nav-item">
                    <div class="dropdown">
                        <button class="btn btn-link dropdown-toggle" type="button" id="dropdownMenuButton6" data-bs-toggle="collapse" data-bs-target="#employeeManagement" aria-expanded="false" aria-controls="employeeManagement">
                            <img src="/images/common/직원관리.png" class="img-menuicon">
                            직원 관리
                        </button>
                        <div class="collapse" id="employeeManagement">
                            <ul class="list-unstyled">
                                <li class="d-flex justify-content-between align-items-center">
                                    <a th:href="@{/management/list}">직원 목록 조회</a>
                                    <a href="javascript:void(0);" class="ml-auto bookmark-btn" data-menu-id="13">
                                        <img src="/images/common/pin_no.png" class="img-pin">
                                    </a>
                                </li>
                                <li class="d-flex justify-content-between align-items-center">
                                    <a th:href="@{/management/insert}">신규 직원 등록</a>
                                    <a href="javascript:void(0);" class="ml-auto bookmark-btn" data-menu-id="14">
                                        <img src="/images/common/pin_no.png" class="img-pin">
                                    </a>
                                </li>
                                <li class="d-flex justify-content-between align-items-center">
                                    <a th:href="@{/management/employees}">직원 정보 관리</a>
                                    <a href="javascript:void(0);" class="ml-auto bookmark-btn" data-menu-id="15">
                                        <img src="/images/common/pin_no.png" class="img-pin">
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </li>
                <li class="nav-item">
                    <div class="dropdown">
                        <button class="btn btn-link dropdown-toggle" type="button" id="dropdownMenuButton5" data-bs-toggle="collapse" data-bs-target="#boardManagement" aria-expanded="false" aria-controls="boardManagement">
                            <img src="/images/common/게시판.png" class="img-menuicon">
                            게시판
                        </button>
                        <div class="collapse" id="boardManagement">
                            <ul class="list-unstyled">
                                <li class="d-flex justify-content-between align-items-center">
                                    <a th:href="@{/inquire/list}">게시글 목록</a>
                                    <a href="javascript:void(0);" class="ml-auto bookmark-btn" data-menu-id="16">
                                        <img src="/images/common/pin_no.png" class="img-pin">
                                    </a>
                                </li>
                                <li class="d-flex justify-content-between align-items-center">
                                    <a th:href="@{/inquire/insert}">게시글 등록</a>
                                    <a href="javascript:void(0);" class="ml-auto bookmark-btn" data-menu-id="17">
                                        <img src="/images/common/pin_no.png" class="img-pin">
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </li>
                <li class="nav-item">
                    <div class="dropdown">
                        <button class="btn btn-link dropdown-toggle" type="button" id="dropdownMenuButton7" data-bs-toggle="collapse" data-bs-target="#systemManagement" aria-expanded="false" aria-controls="systemManagement">
                            <img src="/images/common/시스템관리.png" class="img-menuicon">
                            시스템 관리
                        </button>
                        <div class="collapse" id="systemManagement">
                            <ul class="list-unstyled">
                                <li class="d-flex justify-content-between align-items-center">
                                    <a th:href="@{/system/inquire}">게시판 관리</a>
                                    <a href="javascript:void(0);" class="ml-auto bookmark-btn" data-menu-id="18">
                                        <img src="/images/common/pin_no.png" class="img-pin">
                                    </a>
                                </li>
                                <li class="d-flex justify-content-between align-items-center">
                                    <a th:href="@{/system/auth}">권한 관리</a>
                                    <a href="javascript:void(0);" class="ml-auto bookmark-btn" data-menu-id="19">
                                        <img src="/images/common/pin_no.png" class="img-pin">
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </li>
            </ul>
        </div>
    </div>
    <script>
        // 사용자 프로필 정보 로드
        function loadUserProfileInfo() {
            const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

            fetch('/user/info', {
                method: 'GET',
                headers: {
                    [csrfHeader]: csrfToken, // CSRF 토큰 추가
                },
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    console.error('Failed to fetch user info');
                    return null;
                }
            })
            .then(data => {
                if (data) {
                    // 프로필 이미지 업데이트
                    const profileImage = document.getElementById('userProfileImage');
                    profileImage.src = data.user_imgpath || '/images/common/profile.png';

                    // 이름과 직위 업데이트
                    const profileName = document.getElementById('userProfileName');
                    profileName.textContent = `${data.user_name} ${data.code_nm} 님`;
                }
            })
            .catch(error => {
                console.error('Error fetching user profile info:', error);
            });
        }

        // 북마크 상태를 서버에서 가져와 적용
        function loadBookmarks() {
            const csrfToken = $('meta[name="_csrf"]').attr('content');
            const csrfHeader = $('meta[name="_csrf_header"]').attr('content');
            fetch('/bookmark/list', {
                method: 'GET',
            })
            .then(response => response.json())
            .then(bookmarkedMenuIds => {
                // 북마크된 menu_id 목록을 순회하며 UI 업데이트
                document.querySelectorAll('.bookmark-btn').forEach(btn => {
                    const menuId = btn.getAttribute('data-menu-id');
                    if (bookmarkedMenuIds.includes(Number(menuId))) {
                        // 북마크된 상태의 이미지로 변경
                        btn.querySelector('img').src = '/images/common/pin_ok.png';
                    }
                });
            });
        }

        // 북마크 버튼 클릭 이벤트
        document.querySelectorAll('.bookmark-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const menuId = this.getAttribute('data-menu-id');
                const csrfToken = $('meta[name="_csrf"]').attr('content');
                const csrfHeader = $('meta[name="_csrf_header"]').attr('content');

                fetch('/bookmark/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        [csrfHeader]: csrfToken,
                    },
                    body: `menuId=${menuId}`
                })
                .then(response => {
                    if (response.ok) {
                        alert('북마크에 추가되었습니다!');
                        this.querySelector('img').src = '/images/common/pin_ok.png';
                        window.location.reload();
                    } else {
                        response.text().then(msg => alert(msg));
                    }
                });
            });
        });

        // DOMContentLoaded 이벤트로 모든 기능 초기화
        document.addEventListener('DOMContentLoaded', () => {
            loadUserProfileInfo(); // 사용자 프로필 정보 로드
            loadBookmarks(); // 북마크 상태 로드
            setupBookmarkButtons(); // 북마크 버튼 클릭 이벤트 설정
        });
    </script>
</div>