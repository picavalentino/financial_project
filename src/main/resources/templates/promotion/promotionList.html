<!DOCTYPE html>
<html xmlns:th="www.thymeleaf.org" xmlns:layout="www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/layout}">
<!--security 적용 후 아래 코드로 변경해주세요-->
<!--<html xmlns:th="www.thymeleaf.org" xmlns:layout="www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/layout}" xmlns:sec="www.thymeleaf.org/extras/spring-security">-->

<meta charset="UTF-8">
<title>GS Bank</title>
<!-- 전체 적용될 CSS -->
<th:block layout:fragment="css"></th:block>
<!-- 전체 적용될 스크립트 -->
<th:block layout:fragment="script"></th:block>

<!-- 우리가 작업할 공간 -->
<body>
<div layout:fragment="content" class="content">
    <h1>상품 설계 조회 페이지입니다.</h1>
    <div>
        <div>
            <label>고객명</label>
            <input type="text" name="custNm">
        </div>
        <div>
            <label>담당자</label>
            <input type="text" name="userNm">
        </div>
        <p></p>
        <div>
            <label>진행상태</label>
            <select name="prgStcd" id="prgStcd" onchange="filterResults()">
                <option value="">전체</option>
                <option value="0">제안중</option>
                <option value="1">추가상담필요</option>
                <option value="2">가입대기</option>
                <option value="3">가입완료</option>
                <option value="4">만기예정</option>
                <option value="5">취소/보류</option>
                <option value="9">해지</option>
            </select>
        </div>
        <div>
            <label>상품유형</label>
            <select name="dsTyCd" id="dsTyCd" onchange="filterResults()">
                <option value="">전체</option>
                <option value="1">적금설계</option>
                <option value="2">목돈마련설계</option>
                <option value="3">예금설계</option>
                <option value="4">대출설계</option>
            </select>
        </div>
        <div>
            <label>상품명</label>
            <input type="text" name="prodNm">
        </div>
        <div>
            <button type="button" onclick="filterResults()">조건검색</button>
            <button type="button" onclick="resetFilters()">전체검색</button>
        </div>
    </div>

    <table>
        <thead>
        <tr>
            <th onclick="sortTable('custNm')">고객명</th>
            <th onclick="sortTable('userNm')">담당자</th>
            <th onclick="sortTable('dsTyCd')">상품유형</th>
            <th onclick="sortTable('prodNm')">상품명</th>
            <th onclick="sortTable('prgStcd')">진행상태</th>
            <th onclick="sortTable('mtrDt')">만기일자</th>
            <th>만기금액(잔액)</th>
        </tr>
        </thead>
        <tbody id="result-table-body">
        <tr th:each="productDesign : ${PromotionList}"
            th:attr="data-dsgn-sn=${productDesign.dsgnSn}"
            onclick="handleRowClick(this)">
            <td th:text="${productDesign.custNm}"></td>
            <td th:text="${productDesign.userNm}"></td>
            <td>
                <span th:if="${productDesign.dsTyCd == '1'}">적금설계</span>
                <span th:if="${productDesign.dsTyCd == '2'}">목돈마련설계</span>
                <span th:if="${productDesign.dsTyCd == '3'}">예금설계</span>
                <span th:if="${productDesign.dsTyCd == '4'}">대출설계</span>
            </td>
            <td th:text="${productDesign.prodNm}"></td>
            <td>
                <span th:if="${productDesign.prgStcd == '0'}">제안중</span>
                <span th:if="${productDesign.prgStcd == '1'}">추가상담필요</span>
                <span th:if="${productDesign.prgStcd == '2'}">가입대기</span>
                <span th:if="${productDesign.prgStcd == '3'}">가입완료</span>
                <span th:if="${productDesign.prgStcd == '4'}">만기예정</span>
                <span th:if="${productDesign.prgStcd == '5'}">취소/보류</span>
                <span th:if="${productDesign.prgStcd == '9'}">해지</span>
            </td>
            <td th:text="${productDesign.mtrDate}"></td>
            <td th:text="${productDesign.mtrAmt}"></td>
        </tr>
        </tbody>
    </table>

    <div id="paginationControls">
        <!-- 이전 페이지 링크 -->
        <span th:if="${currentPage == 1}">&lt;</span>
        <a th:if="${currentPage > 1}" th:href="@{/promotion/list(page=${currentPage - 1}, size=${10})}">&lt;</a>

        <!-- 페이지 번호 -->
        <span th:each="pageNum : ${#numbers.sequence(startPage, endPage)}">
        <a th:if="${pageNum != currentPage}" th:href="@{/promotion/list(page=${pageNum}, size=${10})}" th:text="${pageNum}"></a>
        <span th:if="${pageNum == currentPage}" th:text="${pageNum}"></span>
    </span>

        <!-- 다음 페이지 링크 -->
        <span th:if="${currentPage == totalPages}">&gt;</span>
        <a th:if="${currentPage < totalPages}" th:href="@{/promotion/list(page=${currentPage + 1}, size=${10})}">&gt;</a>
    </div>

    <!-- 자바스크립트 -->
    <script th:inline="javascript">

        let currentSortColumn = null; // 현재 정렬 기준
        let sortDirection = 'asc';   // 기본 정렬 방향 (오름차순)

        // 테이블 정렬
        function sortTable(column) {
            // 정렬 기준이 변경되었는지 확인
            if (currentSortColumn === column) {
                // 동일 기준일 경우 방향 전환 (오름차순 ↔ 내림차순)
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                // 새로운 기준으로 정렬 초기화 (오름차순 시작)
                currentSortColumn = column;
                sortDirection = 'asc';
            }
            // 정렬 기준 및 방향을 적용하여 데이터 재조회
            filterResults(1); // 첫 페이지부터 시작
        }

        // 전체검색 (필터 및 정렬 상태 초기화)
        function resetFilters(page = 1) { // 기본값으로 1페이지를 설정
            // 필터 조건 초기화
            $('#prgStcd').val(''); // 진행 상태 필터 초기화
            $('#dsTyCd').val(''); // 상품 유형 필터 초기화
            $('input[name="custNm"]').val(''); // 고객명 입력 필터 초기화
            $('input[name="userNm"]').val(''); // 담당자 입력 필터 초기화
            $('input[name="prodNm"]').val(''); // 상품명 입력 필터 초기화

            currentSortColumn = null; // 정렬 상태 초기화
            sortDirection = 'asc'; // 기본 정렬 방향을 오름차순으로 설정

            filterResults(page); // 초기화된 필터와 정렬 상태를 기준으로 데이터 재조회
        }

        // 조건검색
        function filterResults(page = 1) {
            const prgStcd = $('#prgStcd').val(); // 진행 상태 선택값 가져오기
            const dsTyCd = $('#dsTyCd').val(); // 상품 유형 선택값 가져오기
            const custNm = $('input[name="custNm"]').val(); // 고객명 입력값
            const userNm = $('input[name="userNm"]').val(); // 담당자 입력값
            const prodNm = $('input[name="prodNm"]').val(); // 상품명 입력값

            // Ajax 요청
            $.ajax({
                url: '/promotion/list',
                method: 'GET',
                data: {
                    prgStcd: prgStcd, // 진행 상태 필터 값
                    dsTyCd: dsTyCd, // 상품 유형 필터 값
                    custNm: custNm, // 고객명 필터 값
                    userNm: userNm, // 담당자 필터 값
                    prodNm: prodNm, // 상품명 필터 값
                    page: page, // 페이지 번호
                    size: 10, // 페이지당 데이터 개수
                    sortColumn: currentSortColumn, // 정렬 기준
                    sortDirection: sortDirection, // 정렬 방향
                    ajax: true // AJAX 요청임을 명시
                },
                success: function(response) {
                    console.log('Response:', response); // 응답 데이터 확인

                    // 기존 테이블 데이터를 초기화
                    const tableBody = $('#result-table-body');
                    tableBody.empty();

                    // 응답 데이터를 기반으로 새로운 테이블 데이터 렌더링
                    if (response.PromotionList && response.PromotionList.length > 0) {
                        response.PromotionList.forEach(productDesign => {

                            console.log('Product Design:', productDesign); // 데이터 확인

                            const row = `
                                <tr>
                                    <td>${productDesign.custNm}</td>
                                    <td>${productDesign.userNm}</td>
                                    <td>${getProductType(productDesign.dsTyCd)}</td>
                                    <td>${productDesign.prodNm}</td>
                                    <td>${getProgressStatus(productDesign.prgStcd)}</td>
                                    <td>${productDesign.mtrDate}</td>
                                    <td>${productDesign.mtrAmt}</td>
                                </tr>
                            `;
                            tableBody.append(row); // 테이블에 행 추가
                        });
                    } else {
                        console.log('No data available.'); // 데이터가 없을 때
                        tableBody.append('<tr><td colspan="6">데이터가 없습니다.</td></tr>');
                    }

                    // 페이지네이션 갱신
                    updatePagination(response.totalPages, response.currentPage);
                },
                error: function(error) {
                    console.error('Error fetching filtered results:', error);
                }
            });
        }

        // 상품 유형 코드 → 이름 변환
        function getProductType(dsTyCd) {
            const types = {
                '1': '적금설계',
                '2': '목돈마련설계',
                '3': '예금설계',
                '4': '대출설계'
            };
            return types[dsTyCd] || '알 수 없음'; // 일치하는 코드가 없을 경우 '알 수 없음' 반환
        }

        // 진행 상태 코드 → 이름 변환
        function getProgressStatus(prgStcd) {
            const statuses = {
                '0': '제안중',
                '1': '추가상담필요',
                '2': '가입대기',
                '3': '가입완료',
                '4': '만기예정',
                '5': '취소/보류',
                '9': '해지'
            };
            return statuses[prgStcd] || '알 수 없음';
        }

        // 페이지네이션 업데이트
        function updatePagination(totalPages, currentPage) {
            const paginationControls = $('#paginationControls');
            paginationControls.empty(); // 기존 페이지네이션 요소 초기화

            // 이전 페이지 버튼
            if (currentPage > 1) {
                paginationControls.append(`<a href="#" onclick="filterResults(${currentPage - 1})">&lt;</a>`);
            } else {
                paginationControls.append(`<span>&lt;</span>`);
            }

            // 페이지 번호
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage) {
                    paginationControls.append(`<span>${i}</span>`);
                } else {
                    paginationControls.append(`<a href="#" onclick="filterResults(${i})">${i}</a>`);
                }
            }

            // 다음 페이지 버튼
            if (currentPage < totalPages) {
                paginationControls.append(`<a href="#" onclick="filterResults(${currentPage + 1})">&gt;</a>`);
            } else {
                paginationControls.append(`<span>&gt;</span>`);
            }
        }

        // 테이블 행 클릭 시 금융계산기 페이지로 이동
        function handleRowClick(row) {
            // 클릭한 행의 data-dsgn-sn 값 가져오기
            const dsgnSn = row.getAttribute('data-dsgn-sn');

            // 금융계산기 페이지로 이동
            if (dsgnSn) {
                window.location.href = `/promotion/cal/detail?dsgnSn=${dsgnSn}`;
            } else {
                console.error('설계번호가 없습니다.');
            }
        }
    </script>
</div>
</body>
</html>