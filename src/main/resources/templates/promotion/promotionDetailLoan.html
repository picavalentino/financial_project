<!DOCTYPE html>
<html xmlns:th="www.thymeleaf.org" xmlns:layout="www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/layout}">
<!--security 적용 후 아래 코드로 변경해주세요-->
<!--<html xmlns:th="www.thymeleaf.org" xmlns:layout="www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/layout}" xmlns:sec="www.thymeleaf.org/extras/spring-security">-->
<head>
    <meta charset="UTF-8">
    <title>GS Bank</title>
    <!-- 전체 적용될 CSS -->
    <th:block layout:fragment="css"></th:block>
    <!-- 전체 적용될 스크립트 -->
    <th:block layout:fragment="script"></th:block>
    <!-- 페이지별 상품 설계 조회 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.1/font/bootstrap-icons.css">
    <link rel="stylesheet" th:href="@{/css/promotion/button.css}">
    <link rel="stylesheet" th:href="@{/css/promotion/common.css}">
    <link rel="stylesheet" th:href="@{/css/promotion/promotionCal.css}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div layout:fragment="content" class="content print-area">
    <div class="main-content">
        <!-- 페이지 위치 & 제목 -->
        <section class="page-location">
            <div class="page-breadcrumb">
                <span class="home-icon"><i class="bi bi-house-door-fill"></i></span>
                <a href="/main">Home</a> &gt;
                <a href="/promotion/list">프로모션관리</a> &gt;
                <span>금융계산기</span>
            </div>
            <h1 class="page-title">금융계산기</h1>
        </section>

        <!-- 설계 탭 -->
        <div class="tabs">
            <button class="tab inactive" onclick="window.location.href='/promotion/cal'">적금 설계</button>
            <button class="tab inactive" onclick="window.location.href='/promotion/CalAcml'">목돈마련적금 설계</button>
            <button class="tab inactive" onclick="window.location.href='/promotion/CalDpst'">예금 설계</button>
            <button class="tab active" onclick="window.location.href='/promotion/CalLoan'">대출 설계</button>
        </div>

        <div class="main-form-container">
            <!-- 고객 폼 -->
            <div class="customer-container hidden">
                <div class="customer-content">
                    <div class="customer-label-group">
                        <label for="custCreateAt">작성일자</label>
                        <label for="custNm">고객명</label>
                        <label for="custBirth">생년월일</label>
                        <label for="custEmail">이메일</label>
                        <label for="custTelno">전화번호</label>
                        <label for="custOccp">직업</label>
                        <label for="custAddr" class="custAddr-label">주소</label>
                        <label for="userNm">담당자</label>
                    </div>
                    <div class="customer-input-group">
                        <input type="hidden" id="custId"> <!-- 고객ID -->
                        <input type="text" id="custCreateAt" disabled>
                        <div class="customer-input-with-button">
                            <input type="text" id="custNm" disabled>
                            <button class="btn-icon" id="openCustomerModalButton"><i class="bi bi-search"></i></button>
                        </div>
                        <input type="text" id="custBirth" disabled>
                        <input type="text" id="custEmail" disabled>
                        <input type="text" id="custTelno" disabled>
                        <input type="text" id="custOccp" disabled>
                        <textarea id="custAddr" disabled></textarea>
                        <input type="hidden" id="userId"> <!-- 담당자ID -->
                        <input type="text" id="userNm" disabled>
                    </div>
                </div>
            </div>

            <!-- 고객 모달 -->
            <div class="modal" id="customerModal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">고객 선택</div>
                        <button id="closeCustomerModalButton">X</button>
                    </div>
                    <div class="modal-body">
                        <!-- 검색 필드 -->
                        <div class="modal-search-bar">
                            <label for="custNmSearch">고객명</label>
                            <input type="text" id="custNmSearch">
                            <label for="custTelnoSearch">전화번호</label>
                            <input type="text" id="custTelnoSearch">
                            <button class="btn-search btn-search-cust">검색</button>
                        </div>
                        <!-- 모달 테이블 -->
                        <div class="modal-table-container">
                            <table class="modal-table cust-tb">
                                <thead>
                                <tr>
                                    <th>고객명</th>
                                    <th>생년월일</th>
                                    <th>전화번호</th>
                                    <th>담당자</th>
                                </tr>
                                </thead>
                                <tbody id="customerList">
                                <tr>
                                    <td>김고객</td>
                                    <td>99-05-01</td>
                                    <td>010-1234-5678</td>
                                    <td>김담당</td>
                                </tr>
                                <tr>
                                    <td>이고객</td>
                                    <td>88-12-21</td>
                                    <td>010-1111-1234</td>
                                    <td>김담당</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 설계 폼 -->
            <div class="form-container">
                <div class="form-content">
                    <div class="label-group">
                        <label for="dsgnSn">설계번호</label>
                        <label for="prodCd">상품선택</label>
                        <label for="prodPayTyCd">납입주기</label>
                        <label for="savgStrtDt">시작일자</label>
                        <label for="savgCircleAmt">대출금액 (원)</label>
                        <label for="savgGoalPrd">대출기간 (개월)</label>
                        <label for="savgAplyRate">대출금리 (%)</label>
                        <label for="repaymentMethod">상환방법</label>
                        <label for="dsgnCreateAt">설계일자</label>
                        <label for="dsgnUpdateAt">작성일자</label>
                    </div>
                    <div class="input-group">
                        <div class="input-group-content">
                            <!-- 설계번호 -->
                            <input type="text" id="dsgnSn" name="dsgnSn" disabled>

                            <!-- 상품선택 -->
                            <div class="input-with-button">
                                <!-- 상품설계번호 -->
                                <input type="hidden" id="prodSn" name="prodSn">
                                <!-- 설계유형코드 -->
                                <input type="hidden" id="prodDsTyCd" name="prodDsTyCd">
                                <!-- 상품코드 -->
                                <input type="text" id="prodCd" name="prodCd" disabled>
                                <!-- 상품명 -->
                                <input type="text" id="prodNm" name="prodNm" readonly>
                                <button><i class="bi bi-search" id="openProductModalButton"></i></button>
                            </div>

                            <!-- 납입주기 -->
                            <!-- 표시용 -->
                            <input type="text" id="prodPayTy" name="prodPayTy" disabled>
                            <!-- 저장용 -->
                            <input type="hidden" id="prodPayTyCd" name="prodPayTyCd">

                            <!-- 시작일자 -->
<!--                            <input type="date" id="savgStrtDt" name="savgStrtDt">-->
                            <div class="input-with-button">
                                <!-- 시작일자 -->
                                <input type="date" id="savgStrtDt" name="savgStrtDt">
                                <!-- 만기일자 -->
                                <label for="savgMtrDt">만기일자</label>
                                <input type="text" id="savgMtrDt" name="savgMtrDt" disabled>
                            </div>

                            <!-- 불입금액 -->
                            <div class="button-row">
                                <input type="text" id="savgCircleAmt" name="savgCircleAmt" value="0">
                                <div class="button-group">
                                    <button class="button-plus button-plus-amt">+ 100만원</button>
                                    <button class="button-plus button-plus-amt">+ 500만원</button>
                                    <button class="button-plus button-plus-amt">+ 1000만원</button>
                                    <button class="button-reset button-reset-amt">정정</button>
                                </div>
                            </div>

                            <!-- 목표기간 -->
                            <div class="button-row">
                                <input type="text" id="savgGoalPrd" name="savgGoalPrd" value="0">
                                <div class="button-group">
                                    <button class="button-plus button-plus-prd">+ 3개월</button>
                                    <button class="button-plus button-plus-prd">+ 6개월</button>
                                    <button class="button-plus button-plus-prd">+ 12개월</button>
                                    <button class="button-reset button-reset-prd">정정</button>
                                </div>
                            </div>

                            <!-- 적용금리 -->
                            <div class="input-rate">
                                <select id="selectSavgAplyRate" name="selectSavgAplyRate">
                                    <option>금리선택</option>
                                    <option value="prodairmin">최소금리</option>
                                    <option value="prodairmax">최대금리</option>
                                </select>
                                <input type="text" id="savgAplyRate" name="savgAplyRate" disabled>
                            </div>

                            <!-- 상환방법 -->
                            <!-- 표시용 -->
                            <div class="input-rate">
                                <select id="repaymentMethod" name="repaymentMethod">
                                    <option>선택</option>
                                    <option value="equalPrincipal">원금균등상환</option>
                                    <option value="equalPrincipalAndInterest">원리금균등상환</option>
                                    <option value="lumpSum">원금만기일시상환</option>
                                </select>
                            </div>
                            <!-- 계산용 -->
                            <input type="hidden" id="prodIntTaxRate" name="prodIntTaxRate">
                            <!-- 저장용 -->
                            <input type="hidden" id="savgIntTaxTyCd" name="savgIntTaxTyCd">

                            <!-- 설계일자 -->
                            <input type="date" id="dsgnCreateAt" name="dsgnCreateAt" disabled>

                            <!-- 수정일자 -->
                            <input type="date" id="dsgnUpdateAt" name="dsgnUpdateAt" disabled>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 상품 모달 -->
        <div class="modal" id="productModal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">상품 선택</div>
                    <button id="closeProductModalButton">X</button>
                </div>
                <div class="modal-body">
                    <!-- 검색 필드 -->
                    <div class="modal-search-bar">
                        <label for="prodCdSearch">상품코드</label>
                        <input type="text" id="prodCdSearch">
                        <label for="prodNmSearch">상품명</label>
                        <input type="text" id="prodNmSearch">
                        <button class="btn-search btn-search-prod">검색</button>
                    </div>
                    <!-- 모달 테이블 -->
                    <div class="modal-table-container">
                        <table class="modal-table prod-tb">
                            <thead>
                            <tr>
                                <th>상품코드</th>
                                <th>상품명</th>
                                <th>가입대상</th>
                            </tr>
                            </thead>
                            <tbody id="productList">
                            <tr>
                                <td>A1000</td>
                                <td>GS사랑행복적금</td>
                                <td>일반 개인</td>
                            </tr>
                            <tr>
                                <td>B2000</td>
                                <td>GS청년희망예금</td>
                                <td>일반 개인</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>


        <!-- 컨트롤 컨테이너-->
        <div class="control-container">
            <!-- 설계 유형 선택 -->
            <div class="radio-group">
                <label><input type="radio" name="calculationType" value="detailed"> 정상설계</label>
                <label><input type="radio" name="calculationType" value="simple" checked> 간편설계</label>
            </div>

            <!-- 우측 버튼 그룹 -->
            <div class="button-group-right">
                <button class="btn-int-cal">이자계산</button>
                <select id="dsgnPrgStcd" name="dsgnPrgStcd">
                    <option value="">진행상태</option>
                    <option th:each="status : ${progressStatusList}"
                            th:value="${status.codNo}"
                            th:text="${status.codNm}"></option>
                </select>
                <button class="btn btn-register">
                    <i class="icon bi bi-plus-circle-fill"></i> 저장
                </button>
                <button class="btn btn-mail">
                    <i class="icon bi bi-printer"></i> 발송
                </button>
                <button class="btn btn-print">
                    <i class="icon bi bi-envelope"></i> 인쇄
                </button>
                <button class="btn btn-list" onclick="location.href='/promotion/list'">
                    <i class="icon bi bi-list"></i> 목록
                </button>
            </div>
        </div>

        <!--  계산 결과 컨테이너 -->
        <div class="calculation-container">
            <!-- 왼쪽 섹션 -->
            <div class="left-section">
                <div class="cal-tab calculation-result-tab">계산 결과</div>
                <div class="calculation-summary">
                    <!-- 계산 결과 간단히 보여주는 입력 필드 -->
                    <div class="result-row">
                        <label>대출액</label>
                        <input type="text" id="savgTotDpstAmt" name="savgTotDpstAmt" readonly>
                    </div>
                    <div class="result-row">
                        <label>총이자</label>
                        <input type="text" id="savgTotDpstInt" name="savgTotDpstInt" readonly>
                    </div>
                    <div class="result-row">
                        <label>총납입금액</label>
                        <input type="text" id="savgAtxRcveAmt" name="savgAtxRcveAmt" readonly>
                    </div>
                </div>
                <div class="cal-tab calculation-chart-tab">계산 차트</div>
                <div class="chart-container">
                    <!-- 차트 출력 -->
                    <canvas id="resultChart"></canvas>
                </div>
            </div>

            <!-- 오른쪽 섹션 -->
            <div class="right-section">
                <div class="non-display">계산 테이블</div>
                <div class="interest-details">
                    <div class="right-section-table-container">
                        <table>
                            <thead>
                            <tr>
                                <th>회차</th>
                                <th>월이자</th>
                                <th>원금</th>
                                <th>총납입금액</th>
                            </tr>
                            </thead>
                            <tbody>
                            <!-- 회차별 상세 정보 데이터 반복 -->
                            <tr>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                            </tr>
                            <!-- ... -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>


    </div>

    <!-- 자바스크립트 -->
    <script th:inline="javascript">
        document.querySelector('.btn-print').addEventListener('click', function () {
                    window.print();
                });

        document.addEventListener('DOMContentLoaded', function () {

            // 날짜 가져오기
            function getTodayDate() {
                const today = new Date();
                today.setMinutes(today.getMinutes() - today.getTimezoneOffset()); // UTC -> 로컬 시간으로 변환
                return today.toISOString().split('T')[0]; // yyyy-mm-dd
            }

            // 날짜 필드 설정 (오늘 날짜)
            const dsgnCreateAt = document.getElementById('dsgnCreateAt');
            const dsgnUpdateAt = document.getElementById('dsgnUpdateAt');
            const savgStrtDt = document.getElementById('savgStrtDt'); // 시작일자

            if (dsgnCreateAt) dsgnCreateAt.value = getTodayDate();
            if (dsgnUpdateAt) dsgnUpdateAt.value = getTodayDate();

            // 시작일자 기본값과 최소값 설정
            if (savgStrtDt) {
                const today = getTodayDate();
                savgStrtDt.value = today; // 기본값 설정
                savgStrtDt.min = today;  // 최소값 설정
            }


            // 만기일자 계산
            const savgGoalPrd = document.getElementById('savgGoalPrd'); // 목표기간
            const savgMtrDt = document.getElementById('savgMtrDt'); // 만기일자

            // 만기일자 계산 함수
            function calculateMaturityDate() {
                const startDateValue = savgStrtDt.value; // 시작일자 값
                const goalPeriodValue = parseInt(savgGoalPrd.value, 10); // 목표기간 값 (개월)

                console.log("시작일자 값:", startDateValue); // 시작일자 확인
                console.log("목표기간 값:", goalPeriodValue); // 목표기간 확인

                if (!startDateValue || isNaN(goalPeriodValue) || goalPeriodValue <= 0) {
                    savgMtrDt.value = ''; // 입력값이 없거나 잘못된 경우 초기화
                    return;
                }

                const startDate = new Date(startDateValue);
                startDate.setMonth(startDate.getMonth() + goalPeriodValue); // 목표기간을 더해 만기일 계산
                savgMtrDt.value = startDate.toISOString().split('T')[0]; // yyyy-mm-dd 형식으로 업데이트
                console.log("계산된 만기일:", savgMtrDt.value); // 계산된 만기일 확인
            }

            // 시작일자 변경 시 만기일 계산
            savgStrtDt.addEventListener('change', () => {
                console.log("시작일자가 변경되었습니다."); // 시작일 변경 확인
                calculateMaturityDate();
            });

            // 목표기간 변경 시 만기일 계산
            savgGoalPrd.addEventListener('input', () => {
                console.log("목표기간이 변경되었습니다."); // 목표기간 변경 확인
                calculateMaturityDate();
            });


            // 불입금액 버튼 처리
            const savgCircleAmtInput = document.getElementById('savgCircleAmt');
            const savgCircleAmtButtons = document.querySelectorAll('.button-plus-amt');
            const savgCircleAmtReset = document.querySelector('.button-reset-amt');

            savgCircleAmtButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // 버튼 텍스트에서 숫자 추출 (ex: "+ 10만원" -> "10")
                    const amountToAdd = parseInt(button.innerText.replace(/[^0-9]/g, '')) * 10000;
                    const currentAmount = parseInt(savgCircleAmtInput.value.replace(/,/g, '')) || 0;
                    const newAmount = currentAmount + amountToAdd;

                    savgCircleAmtInput.value = newAmount.toLocaleString(); // 3자리 콤마 추가
                });
            });

            savgCircleAmtReset.addEventListener('click', () => {
                savgCircleAmtInput.value = '0'; // 값 초기화
            });

            // 목표기간 처리
            const savgGoalPrdInput = document.getElementById('savgGoalPrd');
            const savgGoalPrdButtons = document.querySelectorAll('.button-plus-prd');
            const savgGoalPrdReset = document.querySelector('.button-reset-prd');

            savgGoalPrdButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // 버튼 텍스트에서 개월 수 추출 (ex: "+ 3개월" -> "3")
                    const monthsToAdd = parseInt(button.innerText.replace(/[^0-9]/g, ''));
                    const currentMonths = parseInt(savgGoalPrdInput.value) || 0;
                    const newMonths = currentMonths + monthsToAdd;

                    // input 값 설정
                    savgGoalPrdInput.value = newMonths; // 값 반영
                    console.log("목표기간 변경됨:", newMonths); // 디버깅 로그

                    // 만기일 계산 함수 호출
                    calculateMaturityDate();
                });
            });

            savgGoalPrdReset.addEventListener('click', () => {
                // input 값 초기화
                savgGoalPrdInput.value = '0'; // 값 초기화
                console.log("목표기간 초기화됨:", 0); // 디버깅 로그

                // 만기일 계산 함수 호출
                calculateMaturityDate();
            });


            // 설계유형 선택에 따른 화면 출력
            const calculationTypeRadios = document.querySelectorAll('input[name="calculationType"]');
            const mainFormContainer = document.querySelector('.main-form-container');
            const customerContainer = document.querySelector('.customer-container');

            calculationTypeRadios.forEach(radio => {
                radio.addEventListener('change', function () {
                    if (this.value === 'detailed') {
                        // 정상설계 선택: 고객 컨테이너 표시 및 가로 배치 활성화
                        mainFormContainer.classList.add('horizontal');
                        customerContainer.classList.add('visible');
                    } else {
                       // 간편설계를 선택하더라도 "정상설계"로 강제 변경
                       calculationTypeRadios.forEach(r => {
                            if (r.value === 'detailed') {
                                r.checked = true; // "정상설계"로 선택
                            }
                        });

                       // 정상설계 상태 유지
                       mainFormContainer.classList.add('horizontal');
                       customerContainer.classList.add('visible');
                    }
                });
            });

            // 초기 상태를 "정상설계"로 설정
            calculationTypeRadios.forEach(radio => {
                if (radio.value === 'detailed') {
                    radio.checked = true;
                    mainFormContainer.classList.add('horizontal');
                    customerContainer.classList.add('visible');
                }
            });


            // 라디오 버튼 선택에 따라 출력 변경
            const defaultRadio = document.querySelector('input[name="calculationType"]:checked');
            if (defaultRadio && defaultRadio.value === 'detailed') {
                mainFormContainer.classList.add('horizontal');
                customerContainer.classList.add('visible');
            } else {
                mainFormContainer.classList.remove('horizontal');
                customerContainer.classList.remove('visible');
            }


            // 상품 모달
            const productModal = document.getElementById("productModal");
            const productTableBody = document.getElementById("productList");
            const openProductModalButton = document.getElementById("openProductModalButton");
            const closeProductModalButton = document.getElementById("closeProductModalButton");
            const searchProductButton = document.querySelector(".btn-search-prod");

            // 상품 리스트 가져오기
            async function loadProductList(productCode = '', productName = '') {
                try {
                    const response = await fetch(`/promotion/cal/loanProductList?prodCd=${encodeURIComponent(productCode)}&prodNm=${encodeURIComponent(productName)}`);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const productList = await response.json();
                    renderProductTable(productList);
                } catch (error) {
                    console.error('Error fetching product list:', error);
                    alert('상품 데이터를 불러오는 중 오류가 발생했습니다.');
                }
            }

            // 상품 모달 - 테이블 렌더링
            function renderProductTable(productList) {
                productTableBody.innerHTML = '';
                if (productList.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="3">검색 결과가 없습니다.</td>`;
                    productTableBody.appendChild(row);
                    return;
                }
                productList.forEach(product => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${product.prodCd}</td>
                        <td>${product.prodNm}</td>
                        <td>${product.prodSbstgTy}</td>
                    `;
                    // 테이블 행 클릭 이벤트 추가
                    row.addEventListener('click', () => {
                        // 선택한 상품 정보를 폼에 뿌려줌
                        populateProductForm(product);
                        // 모달 닫기
                        document.getElementById('productModal').style.display = 'none';
                    });
                    productTableBody.appendChild(row);
                });
            }

            // 설계 폼에 데이터 뿌려주는 함수
            function populateProductForm(product) {
                // 상품설계번호, 설계유형코드, 상품코드, 상품명
                document.getElementById('prodSn').value = product.prodSn || '';
                document.getElementById('prodDsTyCd').value = product.prodDsTyCd || '';
                document.getElementById('prodCd').value = product.prodCd || '';
                document.getElementById('prodNm').value = product.prodNm || '';

                // 납입주기
                // 표시용
                document.getElementById('prodPayTy').value = product.prodPayTy || '';
                // 저장용
                document.getElementById('prodPayTyCd').value = product.prodPayTyCd || '';

                // 적용금리
                const rateSelect = document.getElementById('selectSavgAplyRate');
                const rateInput = document.getElementById('savgAplyRate');
                // 금리 선택 변경 시 동작
                rateSelect.addEventListener('change', () => {
                    const selectedValue = rateSelect.value; // 선택된 값 (prodairmin 또는 prodairmax)
                    if (selectedValue === 'prodairmin') {
                        rateInput.value = product.prodAirMin ? `${product.prodAirMin}` : '';
                    } else if (selectedValue === 'prodairmax') {
                        rateInput.value = product.prodAirMax ? `${product.prodAirMax}` : '';
                    } else {
                        rateInput.value = ''; // 기본값 (선택되지 않은 경우)
                    }
                });
                // 초기값 설정 (최소금리로 시작)
                if (rateSelect.value === 'prodairmin') {
                    rateInput.value = product.prodAirMin ? `${product.prodAirMin}` : '';
                }


            }

            // 상품 모달 열기
            openProductModalButton.addEventListener("click", () => {
                // 모달 먼저 표시
                requestAnimationFrame(() => {
                    productModal.style.display = "flex";
                });

                // 데이터 로드는 비동기로 처리
                setTimeout(async () => {
                    // 모달 필드 초기화
                    document.getElementById('prodCdSearch').value = '';
                    document.getElementById('prodNmSearch').value = '';
                    await loadProductList(); // 전체 리스트 로드
                }, 0);
            });

            // 상품 모달 닫기
            closeProductModalButton.addEventListener("click", () => {
                productModal.style.display = "none";
            });

            // 상품 검색 버튼 클릭 이벤트
            searchProductButton.addEventListener("click", () => {
                const productCode = document.getElementById('prodCdSearch').value.trim();
                const productName = document.getElementById('prodNmSearch').value.trim();
                loadProductList(productCode, productName);
            });


            // 고객 모달
            const customerModal = document.getElementById("customerModal");
            const customerTableBody = document.getElementById("customerList");
            const openCustomerModalButton = document.getElementById("openCustomerModalButton");
            const closeCustomerModalButton = document.getElementById("closeCustomerModalButton");
            const searchCustomerButton = document.querySelector(".btn-search-cust");

            // 고객 리스트 가져오기
            async function loadCustomerList(custNm = '', custTelno = '') {
                try {
                    // 검색 조건에 따라 API 호출 URL 생성
                    const url = `/promotion/cal/userInfoList?custNm=${encodeURIComponent(custNm)}&custTelno=${encodeURIComponent(custTelno)}`;
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const userInfoList = await response.json();
                    renderCustomerList(userInfoList);
                } catch (error) {
                    console.error('Error fetching customer list:', error);
                    alert('고객 데이터를 불러오는 중 오류가 발생했습니다.');
                }
            }

            // 고객 모달 - 테이블 렌더링
            function renderCustomerList(userInfoList) {
                customerTableBody.innerHTML = ''; // 기존 데이터를 초기화
                if (userInfoList.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="4">검색 결과가 없습니다.</td>`;
                    customerTableBody.appendChild(row);
                    return;
                }
                userInfoList.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.custNm}</td>
                        <td>${user.custBirth}</td>
                        <td>${user.custTelno}</td>
                        <td>${user.userName}</td>
                    `;

                    // 테이블 행 클릭 이벤트 추가
                    row.addEventListener('click', () => {
                        // 선택한 고객 정보를 폼에 뿌려줌
                        populateCustomerForm(user);
                        // 모달 닫기
                        customerModal.style.display = "none";
                    });
                    customerTableBody.appendChild(row);
                });
            }

            // 고객 폼에 데이터 뿌려주는 함수
            function populateCustomerForm(user) {
                document.getElementById('custId').value = user.custId || ''; // 고객ID
                document.getElementById('custCreateAt').value = user.custCreateAt || ''; // 작성일자
                document.getElementById('custNm').value = user.custNm || ''; // 고객명
                document.getElementById('custBirth').value = user.custBirth || ''; // 생년월일
                document.getElementById('custEmail').value = user.custEmail || ''; // 이메일
                document.getElementById('custTelno').value = user.custTelno || ''; // 전화번호
                document.getElementById('custOccp').value = user.custOccp || ''; // 직업
                document.getElementById('custAddr').value = user.custAddr || ''; // 주소
                document.getElementById('userId').value = user.userId || ''; // 담당자ID
                document.getElementById('userNm').value = user.userName || ''; // 담당자
            }

            // 고객 모달 열기 (모달이 열릴 때 데이터 로드)
            openCustomerModalButton.addEventListener("click", async () => {
                customerModal.style.display = "flex";
                // 모달 필드 초기화
                document.getElementById('custNmSearch').value = '';
                document.getElementById('custTelnoSearch').value = '';
                await loadCustomerList(); // 전체 리스트 로드
            });

            // 고객 모달 닫기
            closeCustomerModalButton.addEventListener("click", () => {
                customerModal.style.display = "none";
            });

            // 검색 버튼 클릭 이벤트
            searchCustomerButton.addEventListener("click", async () => {
                const custNm = document.getElementById('custNmSearch').value.trim();
                const custTelno = document.getElementById('custTelnoSearch').value.trim();
                await loadCustomerList(custNm, custTelno); // 검색 조건으로 데이터 로드
            });

            // 모달 외부 클릭 시 닫기 (모달 공통)
            window.addEventListener("click", (event) => {
                if (event.target === customerModal) {
                    customerModal.style.display = "none";
                }
                if (event.target === productModal) {
                    productModal.style.display = "none";
                }
            });


            initializeChart(); // 차트 초기화
            console.log("Chart initialized:", resultChart); // 초기화 상태 확인

            // '이자 계산' 버튼 클릭 이벤트 추가
            document.querySelector('.btn-int-cal').addEventListener('click', handleInterestCalculation);
        });

        // 차트 초기화 함수
        function initializeChart() {
            const ctx = document.getElementById('resultChart').getContext('2d');
            resultChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['대출액', '총이자', '총납입금액'],
                    datasets: [{
                        label: '계산 결과',
                        data: [0, 0, 0], // 초기 데이터
                        backgroundColor: [
                            '#4CAF50', // 대출액
                            '#FF9800', // 총이자
                            '#03A9F4', // 총납입금액
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString(); // 천 단위 쉼표 추가
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.raw.toLocaleString()}원`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // 이자 계산 핸들러 함수
        function handleInterestCalculation() {

            if (!resultChart) {
                console.error("resultChart가 초기화되지 않았습니다.");
                return;
            }

            // 데이터 유효성 검사
            const savgCircleAmt = document.getElementById('savgCircleAmt').value.trim();
            const savgGoalPrd = document.getElementById('savgGoalPrd').value.trim();
            const savgAplyRate = document.getElementById('savgAplyRate').value.trim();
            const repaymentMethod = document.getElementById('repaymentMethod').value;

            // 유효성 검사
            if (!savgCircleAmt || parseFloat(savgCircleAmt) <= 0) {
                alert('대출금액을 입력하세요.');
                return;
            }
            if (!savgGoalPrd || parseInt(savgGoalPrd) <= 0) {
                alert('대출기간을 입력하세요.');
                return;
            }
            if (!savgAplyRate || parseFloat(savgAplyRate) <= 0) {
                alert('적용금리를 입력하세요.');
                return;
            }
            if (repaymentMethod === "선택") {
                alert('상환 방법을 선택하세요.');
                return;
    }

            const requestData = {
                savgCircleAmt: parseFloat(savgCircleAmt.replace(/,/g, '')),
                savgGoalPrd: parseInt(savgGoalPrd),
                savgAplyRate: parseFloat(savgAplyRate),
                prodIntTaxRate: parseFloat(document.getElementById('prodIntTaxRate').value),
                savgStrtDt: document.getElementById('savgStrtDt').value,
            };

            // 상환 방법에 따른 URL 결정
            let url;
            switch (repaymentMethod) {
                case "equalPrincipal":
                    url = '/promotion/cal/equalPrincipal';
                    break;
                case "equalPrincipalAndInterest":
                    url = '/promotion/cal/equalPrincipalAndInterest';
                    break;
                case "lumpSum":
                    url = '/promotion/cal/lumpSum';
                    break;
                default:
                    alert('잘못된 상환 방법입니다.');
                    return;
            }

            // 서버 요청
            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData),
            })
                .then((response) => {
                    if (!response.ok) throw new Error('서버 응답 오류');
                    return response.json();
                })
                .then(updateCalculationResults) // 결과 업데이트
                .catch((error) => {
                    console.error('Error:', error);
                    alert('계산 중 오류가 발생했습니다.');
                });
        }

        // 계산 결과 업데이트 함수
        function updateCalculationResults(data) {
            document.getElementById('savgTotDpstAmt').value = data.savgTotDpstAmt.toLocaleString();
            document.getElementById('savgTotDpstInt').value = data.savgTotDpstInt.toLocaleString();
            document.getElementById('savgAtxRcveAmt').value = data.savgAtxRcveAmt.toLocaleString();

            // 차트 데이터 업데이트
            if (resultChart && resultChart.data && resultChart.data.datasets) {
                resultChart.data.datasets[0].data = [
                    data.savgTotDpstAmt,
                    data.savgTotDpstInt,
                    data.savgAtxRcveAmt
                ];
                resultChart.update(); // 차트 새로고침
                console.log("차트 업데이트 완료: ", resultChart.data.datasets[0].data);
            } else {
                console.error("resultChart가 초기화되지 않았습니다.");
            }

            // 상세 테이블 데이터 업데이트
            const detailTableBody = document.querySelector('.interest-details tbody');
            detailTableBody.innerHTML = '';
            data.detailList.forEach((detail) => {
                const row = `
                    <tr>
                        <td>${detail.installment}</td>
                        <td>${detail.monthlyInterest.toLocaleString()}</td>
                        <td>${detail.principal.toLocaleString()}</td>
                        <td>${detail.totalPayment.toLocaleString()}</td>
                    </tr>`;
                detailTableBody.insertAdjacentHTML('beforeend', row);
            });
        }

        document.querySelector('.btn-register').addEventListener('click', () => {

            // 상품 선택 확인
            const prodSn = document.getElementById('prodSn').value.trim();
            if (!prodSn) {
                alert('상품 조회 후 저장이 가능합니다.');
                return;
            }

            // 현재 설계 유형 확인
            const calculationType = document.querySelector('input[name="calculationType"]:checked').value;
            if (calculationType !== 'detailed') {
                alert('정상설계만 저장이 가능합니다.');
                return;
            }

            // userId와 custId 값 확인
            const userId = document.getElementById('userId').value.trim();
            const custId = document.getElementById('custId').value.trim();
            if (!userId || !custId) {
                alert('고객 조회 후 저장이 가능합니다.');
                return;
            }

            // 이자 계산 확인
            const savgTotDpstInt = document.getElementById('savgTotDpstInt').value.trim();
            if (!savgTotDpstInt || parseFloat(savgTotDpstInt) <= 0) {
                alert('이자계산 후 저장이 가능합니다.');
                return;
            }

            // 진행상태 확인
            const dsgnPrgStcd = document.getElementById('dsgnPrgStcd').value.trim();
            if (!dsgnPrgStcd) {
                alert('진행상태 선택 후 저장이 가능합니다.');
                return;
            }

            // 유효성 검사가 통과되면 데이터 수집 및 저장
            const repaymentMethodSelect = document.getElementById('repaymentMethod'); // 셀렉트 박스
            const repaymentMethodValue = repaymentMethodSelect.value; // 선택된 값

            // 셀렉트 값에 따라 추가 데이터 매핑
            let repaymentMethodCode;
            if (repaymentMethodValue === 'equalPrincipal') {
                repaymentMethodCode = 3;
            } else if (repaymentMethodValue === 'equalPrincipalAndInterest') {
                repaymentMethodCode = 1;
            } else if (repaymentMethodValue === 'lumpSum') {
                repaymentMethodCode = 2;
            } else {
                alert('상환 방법을 선택하세요.');
                return; // 유효하지 않은 경우 함수 종료
            }

            const savingsSaveDto = {
                prodSn: prodSn, // 상품번호
                custId: custId, // 고객ID
                userId: userId, // 담당자ID
                dsgnCreateAt: document.getElementById('dsgnCreateAt').value, // 설계일자
                dsgnUpdateAt: document.getElementById('dsgnUpdateAt').value, // 수정일자
                prodDsTyCd: document.getElementById('prodDsTyCd').value, // 설계유형코드
                dsgnPrgStcd: dsgnPrgStcd, // 진행상태코드
                prodPayTyCd: document.getElementById('prodPayTyCd').value, // 납입주기코드
                savgGoalPrd: parseInt(document.getElementById('savgGoalPrd').value, 10), // 목표기간
                savgStrtDt: document.getElementById('savgStrtDt').value, // 시작일자
                savgMtrDt: document.getElementById('savgMtrDt').value, // 만기일자
                savgAplyRate: parseFloat(document.getElementById('savgAplyRate').value), // 적용금리
                savgIntTaxTyCd: document.getElementById('savgIntTaxTyCd').value, // 이자과세유형코드
                savgCircleAmt: parseInt(document.getElementById('savgCircleAmt').value.replace(/,/g, ''), 10), // 회차불입액
                savgTotDpstAmt: parseInt(document.getElementById('savgTotDpstAmt').value.replace(/,/g, ''), 10), // 불입금합계
                savgTotDpstInt: parseInt(savgTotDpstInt.replace(/,/g, ''), 10), // 세전이자
                savgAtxRcveAmt: parseInt(document.getElementById('savgAtxRcveAmt').value.replace(/,/g, ''), 10), // 세후수령액
                repaymentMethodCode: repaymentMethodCode // 대출상환방법 코드
            };

<!--            // 데이터 확인 로그-->
<!--            console.log('Collected Data:', data);-->

            // 서버로 POST 요청 전송
            fetch('/promotion/cal/loan/insert', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(savingsSaveDto), // DTO 형태로 JSON 변환
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('서버 응답 오류');
                    }
                    return response.text(); // 서버 응답 텍스트 처리
                })
                .then(result => {
                    alert(result); // 성공 메시지 출력
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('저장 중 오류가 발생했습니다.');
                });

        });
    </script>
</div>
</body>
</html>