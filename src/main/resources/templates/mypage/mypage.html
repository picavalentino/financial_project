<!DOCTYPE html>
<html xmlns:th="www.thymeleaf.org" xmlns:layout="www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/layout}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>마이페이지</title>
    <link rel="stylesheet" th:href="@{/css/mypage/mypage.css}">
</head>

<body>
<div layout:fragment="content" class="content">
    <h1>나의 정보</h1>
    <div class="content1">
        <div class="mypage_right">
            <form id="updateForm" method="POST" action="/mypage/update" enctype="multipart/form-data">
                <!-- CSRF 토큰 추가 -->
                <input type="hidden" name="_csrf" th:value="${_csrf.token}" />

                <div id="myprofile_mid">
                    <img id="profile_img"
                         th:src="${mypageDTO.userImgpath != null ? mypageDTO.userImgpath : '/css/mypage/img/mypage_default_profile.jpg'}"
                         alt="Profile Image" />
                    <label for="file" class="custom-file-upload">파일 선택</label>
                    <input type="file" id="file" name="profileImage">
                    <button type="button" id="pw_edit">비밀번호 변경하기</button>
                </div>
                <div class="input_box">
                    <div id="myprofile_left">
                        <p>사원번호 <br>
                            <input type="text" id="user_id" name="userId" th:value="${mypageDTO.userId}" disabled>
                        </p>
                        <p>입사일 <br>
                            <input type="text" id="user_jncmp_ymd" name="userIncmpYmd" th:value="${mypageDTO.userJncmpYmd}" disabled>
                        </p>
                        <p>부서 <br>
                            <input type="text" id="user_dept_cd_code_cl" name="userDeptCdCodeCl" th:value="${mypageDTO.userDeptName}" disabled>
                        </p>
                        <p>직무 <br>
                            <input type="text" id="user_jbps_ty_cd_code_cl" name="userJbpsTyCdCodeCl" th:value="${mypageDTO.userJobName}" disabled>
                        </p>
                    </div>
                    <div id="myprofile_right">
                        <p>이름 <br>
                            <input type="text" id="user_name" name="userName" th:value="${mypageDTO.userName}">
                        </p>
                        <div class="phone">
                            <p>휴대전화 <br>
                                <input class="phone" type="text" id="phone_input1" name="phonePart1" th:value="${#strings.substring(mypageDTO.userTelno, 0, 3)}"> -
                                <input class="phone" type="text" id="phone_input2" name="phonePart2" th:value="${#strings.substring(mypageDTO.userTelno, 4, 8)}"> -
                                <input class="phone" type="text" id="phone_input3" name="phonePart3" th:value="${#strings.substring(mypageDTO.userTelno, 9)}">
                            </p>
                        </div>
                        <p>E-Mail <br>
                            <input type="email" id="user_email" name="userEmail" th:value="${mypageDTO.userEmail}">
                        </p>
                        <div class="buttons">
                            <button type="submit" id="adminButton">등록하기</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <div class="mypage_left">
            <div class="mycustomer">
                <div id="mycustomer_title">
                    <p>나의 고객 정보:</p>
                    <button type="button">더보기</button>
                </div>

                <table id="mycustomer_table">
                    <thead>
                    <tr>
                        <th>고객 이름</th>
                        <th>가입 상품</th>
                        <th>이메일</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="customer : ${mypageDTO.custProds}">
                        <td th:text="${customer.custNm}"></td>
                        <td th:text="${customer.dsgnDsTyCdName}"></td>
                        <td th:text="${customer.custEmail}"></td>
                    </tr>
                    <tr th:if="${mypageDTO.custProds.size()} == 0">
                        <td colspan="3">고객 정보가 없습니다.</td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div class="myboard">
                <div id="myboard_title">
                    <p>내 작성글:</p>
                    <button type="button">더보기</button>
                </div>

                <table id="myboard_table">
                    <thead>
                    <tr>
                        <th>제목</th>
                        <th>사원번호</th>
                        <th>작성일</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="inquiry : ${mypageDTO.inquiries}">
                        <td th:text="${inquiry.inqTitle}"></td>
                        <td th:text="${mypageDTO.userId}"></td>
                        <td th:text="${#strings.substring(inquiry.inqCreateAt.toString(), 0, 10)}"></td>
                    </tr>
                    <tr th:if="${mypageDTO.inquiries.size()} == 0">
                        <td colspan="3">작성글이 없습니다.</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>비밀번호 변경하기</h2>
            <form id="passwordChangeForm" method="POST" action="/mypage/update" enctype="multipart/form-data">
                <label for="newPassword">변경 비밀번호</label>
                <div class="password-wrapper">
                    <input type="password" id="newPassword" placeholder="비밀번호를 입력해주세요.">
                    <button type="button" id="eyeIcon" class="eye-button">
                        <img id="eye-open" th:src="@{/images/common/icon-eye.png}" alt="눈 이미지" style="display: block;">
                        <img id="eye-close" th:src="@{/images/common/icon-hide.png}" alt="숨김 이미지" style="display: none;">
                    </button>

                </div>
                <label for="confirmPassword">비밀번호 확인</label>
                <input type="password" id="confirmPassword" placeholder="비밀번호를 입력해주세요.">
                <button class="modal-button" type="button" id="changePasswordBtn">변경</button>
            </form>
        </div>
    </div>

<script th:inline="javascript">
    $(document).ready(function () {
    const userId = $("#user_id").val(); // userId 값을 가져오기
    const apiUrl = `/mypage/${userId}`; // API 엔드포인트
    const $editButton = $("#editButton"); // "수정하기" 버튼
    const $adminButton = $("#adminButton"); // "등록하기" 버튼

    const $email = $("input[type='email']"); // 이메일 입력 필드
    const $form = $("#updateForm"); // 폼 객체


     const $eyeIcon = $("#eyeIcon"); // 눈 버튼
    const $newPassword = $("#newPassword"); // 입력 필드
    const $eyeOpen = $("#eye-open"); // 눈 열림 아이콘
    const $eyeClose = $("#eye-close"); // 눈 닫힘 아이콘

    // 눈 버튼 클릭 이벤트
    $eyeIcon.on("click", function () {
        const currentType = $newPassword.attr("type"); // 현재 입력 필드 타입

        if (currentType === "password") {
            $newPassword.attr("type", "text"); // 입력값 보이기
            $eyeOpen.hide(); // 열림 아이콘 숨기기
            $eyeClose.show(); // 닫힘 아이콘 보이기
        } else {
            $newPassword.attr("type", "password"); // 입력값 숨기기
            $eyeOpen.show(); // 열림 아이콘 보이기
            $eyeClose.hide(); // 닫힘 아이콘 숨기기
        }
    });

    // "수정하기" 버튼 클릭 시
    $editButton.on("click", function () {
        console.log("수정하기 버튼 클릭됨");
        $(".phone").prop("disabled", false);
        $("#user_name").prop("disabled", false);
        $email.prop("disabled", false); // 이메일 필드 활성화
    });

    // "등록하기" 버튼 클릭 시
    $adminButton.on("click", function () {
        console.log("등록하기 버튼 클릭됨");
         $(".phone").prop("disabled", true);
        $("#user_name").prop("disabled", true); // 비활성화 해제 (폼에 데이터 포함)
        $email.prop("disabled", false);
        $form.submit(); // 폼 제출
    });

    // 폼 제출 시 AJAX 처리
  $("#updateForm").on("submit", function (event) {
    event.preventDefault();

    // 사용자 정보 업데이트 데이터 객체
    const userUpdateData = {
        userId: $("#user_id").val(),
        userName: $("#user_name").val(),
        userEmail: $("#user_email").val(),
        userTelno: $("#phone_input1").val() + "-" + $("#phone_input2").val() + "-" + $("#phone_input3").val(),
        userImgpath: $("#file").val()
    };

    // 사용자 정보 업데이트 AJAX 요청
   const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

$.ajax({
    type: "POST",
    url: "/mypage/update",
    contentType: "application/json",
    headers: { [csrfHeader]: csrfToken }, // CSRF 토큰 추가
    data: JSON.stringify(userUpdateData),
    success: function(response) {
        alert("사용자 정보가 성공적으로 수정되었습니다!");
    },
    error: function(xhr, status, error) {
        console.error("서버 오류:", xhr.responseText);
        alert("서버에서 오류가 발생했습니다. 관리자에게 문의하세요.");
    }
});
     const $modal = $("#passwordModal"); // 모달창
    const $openBtn = $("#pw_edit"); // 열기 버튼
    const $closeBtn = $(".close"); // 닫기 버튼
    const $changePasswordBtn = $("#changePasswordBtn"); // 비밀번호 변경 버튼


    // 모달 열기
    $openBtn.on("click", function () {
        $modal.fadeIn(); // 모달창을 페이드인
    });

    // 모달 닫기
    $closeBtn.on("click", function () {
        $modal.fadeOut(); // 모달창을 페이드아웃
    });

    // 모달 외부 클릭 시 닫기
    $(window).on("click", function (e) {
        if ($(e.target).is($modal)) {
            $modal.fadeOut();
        }
    });

   $changePasswordBtn.on("click", function () {
        const newPassword = $("#newPassword").val();
        const confirmPassword = $("#confirmPassword").val();

        if (newPassword === confirmPassword && newPassword !== "") {
            const passwordUpdateData = { newPassword };

            // 비밀번호 변경 AJAX 요청
            $.ajax({
                type: "POST",
                url: "/mypage/update/password",
                contentType: "application/json",
                data: JSON.stringify(passwordUpdateData),
                success: function (response) {
                    alert("비밀번호가 성공적으로 변경되었습니다.");
                    $modal.fadeOut(); // 비밀번호 변경 성공 시 모달 닫기
                },
                error: function (error) {
                    console.error("비밀번호 변경 실패:", error);
                    alert("비밀번호 변경에 실패했습니다.");
                }
            });
        } else {
            alert("비밀번호가 일치하지 않습니다. 다시 입력해주세요.");
        }
    });





    // 데이터를 가져와 페이지에 렌더링
    function fetchAndRenderData() {
        $.ajax({
            type: "GET",
            url: mypage/update,
            success: function (data) {
                console.log("데이터 가져오기 성공:", data);

                // 기본 정보 렌더링
                $("#user_id").val(data.userId || "");
                $("#user_jncmp_ymd").val(data.userJncmpYmd || "");
                $("#user_dept_cd_code_cl").val(data.userDeptName || "");
                $("#user_jbps_ty_cd_code_cl").val(data.userJobName || "");
                $("#user_name").val(data.userName || "");

                // 전화번호 렌더링
                const phone = data.userTelno || "";
                const phoneParts = phone.match(/(\d{3})(\d{4})(\d{4})/);
                if (phoneParts) {
                    $("#phone_input1").val(phoneParts[1]);
                    $("#phone_input2").val(phoneParts[2]);
                    $("#phone_input3").val(phoneParts[3]);
                } else {
                    $("#phone_input1").val("");
                    $("#phone_input2").val("");
                    $("#phone_input3").val("");
                }

                $("#user_email").val(data.userEmail || "");

                // 고객 정보 렌더링
                const customerTable = $("#customer_data");
                if (data.custProds && data.custProds.length > 0) {
                    customerTable.html(
                        data.custProds
                            .map(
                                (customer) => `
                            <tr>
                                <td><a href="#">${customer.custNm}</a></td>
                                <td>${customer.dsgnDsTyCdCodeCl}</td>
                                <td>${customer.custEmail}</td>
                            </tr>
                        `
                            )
                            .join("")
                    );
                } else {
                    customerTable.html(`<tr><td colspan="3">고객 정보가 없습니다.</td></tr>`);
                }

                // 작성글 렌더링
                const boardTable = $("#board_data");
                if (data.inquiries && data.inquiries.length > 0) {
                    boardTable.html(
                        data.inquiries
                            .map(
                                (board) => `
                            <tr>
                                <td><a href="#">${board.inqTitle}</a></td>
                                <td>${data.userId}</td>
                                <td>${board.inqCreateAt}</td>
                            </tr>
                        `
                            )
                            .join("")
                    );
                } else {
                    boardTable.html(`<tr><td colspan="3">작성글이 없습니다.</td></tr>`);
                }
            },
            error: function (error) {
                console.error("데이터 가져오기 실패:", error);
            },
        });
    }

    // 데이터 가져오기 호출
    fetchAndRenderData();
});

</script>


</div>


</body>


</html>