<!DOCTYPE html>
<html xmlns:th="www.thymeleaf.org" xmlns:layout="www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/layout}">
<!--security 적용 후 아래 코드로 변경해주세요-->
<!--<html xmlns:th="www.thymeleaf.org" xmlns:layout="www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/layout}" xmlns:sec="www.thymeleaf.org/extras/spring-security">-->

<meta charset="UTF-8">
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/product/bootstrap.css">
    <link rel="stylesheet" href="/css/product/common.css">
    <link rel="stylesheet" href="/css/product/product-insert.css">
    <link rel="stylesheet" href="/css/buttons/button.css">
</head>

<title>GS Bank</title>
<!-- 전체 적용될 CSS -->
<th:block layout:fragment="css"></th:block>
<!-- 전체 적용될 스크립트 -->
<th:block layout:fragment="script"></th:block>

<!-- 우리가 작업할 공간 -->
<body>
<div layout:fragment="content" class="content">
        <div class="sub_content">
            <div class="location">
                <a th:href="@{/main}"><i class="bi bi-house-door-fill"></i> Home</a>
                <a th:href="@{/product/list}"> / 상품관리</a>
                <p> / 신규상품등록</p>
            </div>
            <div class="produce">
                <h1 class="title">신규상품등록</h1>
                <div class="box_wrap">
                    <form th:action="@{/product/insert/}" method="post" class="product-info" id="product-form">
                        <table class="table-product-form">
                            <tbody>
                            <tr>
                                <th><label>상품명</label></th>
                                <td><input name="prodNm" type="text" placeholder="상품명을 입력하세요"></td>
                            </tr>
                            <tr>
                                <th><label>상품유형</label></th>
                                <td>
                                    <select name="prodTyCd">
                                        <option value="">적금/예금/대출</option>
                                        <option value="1">적금</option>
                                        <option value="2">예금</option>
                                        <option value="3">대출</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <th><label>가입대상</label></th>
                                <td>
                                    <select name="prodSbstgTyCd">
                                        <option value="1">일반개인</option>
                                        <option value="2">청년생활지원</option>
                                        <option value="3">장애자우선지원</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <th><label>가입금액</label></th>
                                <td>
                                    <div class="inp_wrap">
                                        <input id="prodInstlAmtMin" name="prodInstlAmtMin" type="text" placeholder="최소" oninput="formatNumber(this)">
                                        <span>~</span>
                                        <input id="prodInstlAmtMax" name="prodInstlAmtMax" type="text" placeholder="최대" oninput="formatNumber(this)">
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th><label>납입주기</label></th>
                                <td>
                                    <select name="prodPayTyCd">
                                        <option value="1">월납</option>
                                        <option value="3">3개월납</option>
                                        <option value="6">6개월납</option>
                                        <option value="8">년납</option>
                                        <option value="9">일시납</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <th><label>적용이율</label></th>
                                <td>
                                    <div class="inp_wrap">
                                        <input name="prodAirMin" type="text" placeholder="최소">
                                        <span>~</span>
                                        <input name="prodAirMax" type="text" placeholder="최대">
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th><label>적용기간</label></th>
                                <td>
                                    <div class="inp_wrap">
                                        <input name="prodAirBgnYmd" type="date" required>
                                        <span>~</span>
                                        <input name="prodAirEndYmd" type="date" required>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th><label>이자과세구분</label></th>
                                <td>
                                    <select name="prodIntTaxTyCd">
                                        <option value="1">일반과세</option>
                                        <option value="2">세금우대</option>
                                        <option value="3">비과세</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <th><label>판매상태</label></th>
                                <td>
                                    <select name="prodCurrStcd">
                                        <option value="0">판매대기</option>
                                        <option value="1">판매중</option>
                                        <option value="2">판매중지</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <th><label>판매기간</label></th>
                                <td>
                                    <div class="inp_wrap">
                                        <input name="prodNtslBgnYmd" type="date" required>
                                        <span>~</span>
                                        <input name="prodNtslEndYmd" type="date" required>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th>담당직원</th>
                                <td>
                                    <div class="staff-search-container">
                                        <input type="text" id="staffName" name="staffName" readonly placeholder="직원 이름을 검색하세요">
                                        <input type="hidden" id="userId" name="userId">
                                        <button id="btn-search-icon" type="button">
                                            <i class="bi bi-search" ></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </form>
                    <div class="button-wrap">
                        <button class="btn" id="btn-register">
                            <div class="icon-container"><i class="icon bi bi-plus-circle-fill"></i></div> 등록
                        </button>
                        <button class="btn" id="btn-reset">
                            <div class="icon-container"><i class="icon bi bi-arrow-left-circle-fill"></i></div> 초기화
                        </button>
                        <button class="btn" id="btn-list">
                            <div class="icon-container"><i class="icon bi bi-list"></i></div> 목록
                        </button>
                    </div>
                </div>
            </div>
            <!-- 모달 창 -->
            <div id="staffSearchModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <span id="modal-title">담당자명 검색</span>
                    <div class="input-container">
                        <input type="text" id="staffSearchInput" placeholder="직원 이름 입력">
                        <button id="staffSearchButton">검색</button>
                    </div>
                    <div id="staffSearchResults">
                        <!-- 검색 결과가 여기에 표시됩니다 -->
                    </div>
                </div>
            </div>

        </div>

    <script th:inline="javascript">
        // formatNumber 함수 정의
        function formatNumber(input) {
            // 기존 입력값에서 숫자만 추출
            const value = input.value.replace(/[^0-9]/g, '');
            // 천 단위 콤마 추가
            if (value) {
                input.value = new Intl.NumberFormat('ko-KR').format(value);
            } else {
                input.value = ''; // 빈 문자열 처리
            }
        }

        $(document).ready(function () {
            // 필드 유효성 검사 함수
            function validateForm() {
                let isValid = true;
                let errorMessage = "";

                // 가장 먼저 비어 있는 필드를 찾기 위한 변수
                let firstInvalidField = null;

                // 모든 input, select 태그 순회하며 값 확인
                $("#product-form")
                    .find("input, select")
                    .each(function () {
                        const value = $(this).val().trim();
                        if (!value) {
                            if (!firstInvalidField) {
                                // 비어 있는 필드의 레이블 텍스트 가져오기
                                const label = $(this).closest("tr").find("th label").text();
                                firstInvalidField = label;
                            }
                        }
                    });

                if (firstInvalidField) {
                    isValid = false;
                    errorMessage = `${firstInvalidField} 필드를 입력해주세요.`;
                    alert(errorMessage);
                }

                return isValid;
            }

            // 등록 버튼 클릭
            $("#btn-register").on("click", function (e) {
                e.preventDefault(); // 기본 동작 방지

                // 유효성 검사 실행
                if (!validateForm()) {
                    return;
                }

                // 가입금액에서 콤마 제거
                $("#prodInstlAmtMin").val(function () {
                    return $(this).val().replace(/,/g, '');
                });
                $("#prodInstlAmtMax").val(function () {
                    return $(this).val().replace(/,/g, '');
                });

                const formData = $("form.product-info").serialize(); // 폼 데이터 직렬화
                const insertUrl = "/product/insert"; // 등록 요청 URL
                console.log("등록 데이터: ", formData);

                $.ajax({
                    url: insertUrl,
                    type: "POST",
                    data: formData,
                    success: function (response) {
                        alert("신규 상품이 등록되었습니다.");
                        window.location.href = "/product/list"; // 목록 페이지로 이동
                    },
                    error: function (xhr, status, error) {
                        console.error("등록 실패: ", error);
                        alert("상품 등록에 실패했습니다.");
                    },
                });
            });


            // 초기화 버튼 클릭
            $("#btn-reset").on("click", function (e) {
                e.preventDefault(); // 기본 동작 방지
                document.getElementById("product-form").reset(); // 폼 초기화
            });

            // 목록 버튼 클릭
            $("#btn-list").on("click", function (e) {
                e.preventDefault(); // 기본 동작 방지
                window.location.href = "/product/list"; // 목록 페이지로 이동
            });

            // 모달 열기
        $("#btn-search-icon").on("click", function () {
            $("#staffSearchModal").fadeIn();
        });

        // 모달 닫기 버튼
        $(".close").on("click", function () {
            $("#staffSearchModal").fadeOut();
        });

        // 모달 외부 클릭 시 닫기
        $(window).on("click", function (event) {
            if ($(event.target).is("#staffSearchModal")) {
                $("#staffSearchModal").fadeOut();
            }
        });

        $("#staffSearchButton").on("click", function () {
            const searchTerm = $("#staffSearchInput").val().trim();

            if (!searchTerm) {
                alert("검색어를 입력하세요.");
                return;
            }

            // 서버로 Ajax 요청 보내기
            $.ajax({
                url: "/product/user/search", // API 엔드포인트
                type: "GET",
                data: { name: searchTerm }, // 요청 파라미터
                success: function (response) {
                    const resultsContainer = $("#staffSearchResults");
                    resultsContainer.empty();

                    if (response.length === 0) {
                        resultsContainer.append("<p>검색 결과가 없습니다.</p>");
                    } else {
                        // 테이블 생성
                        const table = $(`
                            <table class="staff-table">
                                <thead>
                                    <tr>
                                        <th>사원번호</th>
                                        <th>사원이름</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        `);

                        // 결과 추가
                        response.forEach((item) => {
                            const row = $(`
                                <tr class="result-item" data-id="${item.id}">
                                    <td>${item.id}</td>
                                    <td>${item.name}</td>
                                </tr>
                            `);

                            // 행 클릭 이벤트 추가
                            row.on("click", function () {
                                $("#staffName").val(item.name); // 입력 필드에 이름 설정
                                $("#userId").val(item.id);
                                $("#staffSearchModal").fadeOut(); // 모달 닫기
                            });

                            table.find("tbody").append(row);
                        });

                        resultsContainer.append(table);
                    }
                },
                error: function (xhr, status, error) {
                    console.error("검색 실패: ", error);
                    alert("검색에 실패했습니다. 다시 시도해주세요.");
                },
            });
        });
        // 직원 이름 검색 인풋 필드에서 엔터 키 입력 처리
        $("#staffSearchInput").on("keypress", function (event) {
            if (event.key === "Enter") {
                event.preventDefault(); // 기본 Enter 키 동작(폼 제출) 방지
                $("#staffSearchButton").click(); // 검색 버튼 클릭 이벤트 트리거
            }
        });
    });
    </script>

</div>
</body>
</html>