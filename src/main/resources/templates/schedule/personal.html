<!DOCTYPE html>
<html xmlns:th="www.thymeleaf.org" xmlns:layout="www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/layout}">
<meta name="_csrf" content="CSRF_TOKEN_VALUE">
<meta name="_csrf_header" content="X-CSRF-TOKEN">
<meta name="user_id" th:attr="content=${user_id}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>개인 일정 관리</title>
    <link rel="stylesheet" th:href="@{/css/schedule/personal.css}">
</head>

<body>
<div layout:fragment="content" class="content">
    <div class="location">
        <a th:href="@{/main}"><i class="bi bi-house-door-fill"></i> Home</a>
        <a th:href="@{/schedule/personal}"> / 활동 관리</a>
        <span> / 개인 일정 관리 </span>
    </div>
    <h1 class="title">개인 일정 관리</h1>
    <div class="container1">
        <div class="content1">
            <!-- 캘린더 영역 -->
            <div class="calendar-container">
                <div class="calendar-header">
                    <h2>
                        <button id="btn_left">&lt;</button>
                        <span id="current-month-year"></span>
                        <button id="btn_right">&gt;</button>
                    </h2>
                    <div class="button-container">
                        <button id="schedule_all_btn">전체</button>
                        <button id="schedule_team_btn">팀</button>
                        <button id="schedule_personal_btn">개인</button>
                    </div>
                </div>

                <table class="calendar-table">
                    <thead>
                    <tr>
                        <th id="sun">일</th>
                        <th>월</th>
                        <th>화</th>
                        <th>수</th>
                        <th>목</th>
                        <th>금</th>
                        <th id="sat">토</th>
                    </tr>
                    </thead>
                    <tbody class="calendar-body">
                    <!-- JavaScript로 날짜 생성 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 오늘의 할 일 -->
        <div class="today_task">
            <h3>
                <button id="prev-day-btn">&lt; </button>
                <img th:src="@{/css/schedule/img/task_img.png}" alt="Task">
                <span id="today-date"></span>
                <button id="next-day-btn">&gt;</button>
            </h3>
            <div class="today-tasks-list">
                <!-- JavaScript로 Today Tasks 생성 -->
            </div>
        </div>

    </div>

    <!-- 일정 등록 모달 -->
    <div class="schedule_detail" style="display:none;">
        <div class="scheduler-container">
            <h1>일정 등록</h1>
            <div class="date-display">
                <button id="prev-day">&lt;</button>
                <span id="current-date"></span>
                <button id="next-day">&gt;</button>
            </div>

            <div class="scheduler">
                <span class="close">&times;</span>
                <div class="row">
                    <select class="time-select" id="time-select"></select>
                    <input type="text" class="task-title" placeholder="Enter title...">
                    <input type="text" class="location-input" placeholder="Enter location...">
                    <div class="checkboxes">
                        <label><input type="checkbox" class="select-checkbox" id="team-team"> 팀</label>
                        <label><input type="checkbox" class="select-checkbox" id="team-personal"> 개인</label>
                        <label><input type="checkbox" id="event-allday"> 종일</label>
                    </div>
                </div>
                <div class="details">
                    <textarea class="details-input" placeholder="Enter detailed information..."></textarea>
                </div>
                <input type="submit" id="submit_btn" value="등록">
            </div>
        </div>
    </div>

    <!-- 이벤트 카드 모달 -->
    <div class="event-card" style="display:none;">
        <span class="close-event">&times;</span>
        <div class="card-header">
            <h2 class="event-title"></h2>
            <div class="card-actions">
                <button class="delete-btn"><img id="delete_btn" th:src="@{/css/schedule/img/delete.png}"
                                                alt="Delete"></button>
                <button><img id="email_img" th:src="@{/css/schedule/img/email.png}" alt="Mail"></button>
            </div>
        </div>
        <div class="card-details">
            <div>
                <img th:src="@{/css/schedule/img/time.png}" alt="time">
                <span class="event-time"></span>
            </div>
            <div>
                <img th:src="@{/css/schedule/img/location.png}" alt="place">
                <span class="event-location"></span>
            </div>
            <div>
                <img th:src="@{/css/schedule/img/memo.png}" alt="memo">
                <span class="event-memo"></span>
            </div>
        </div>
    </div>


    <script th:inline="javascript">
        $(document).ready(function () {
            const csrfHeader = $('meta[name="_csrf_header"]').attr('content');
            const csrfToken = $('meta[name="_csrf"]').attr('content');
            console.log("CSRF Header:", csrfHeader);
            console.log("CSRF Token:", csrfToken);

            const scheduleList = /*[[${personalScheduleList}]]*/[]; // 서버에서 전달받은 일정 데이터

            // 현재 날짜 설정
            let currentDate = new Date();

            // 초기화 및 캘린더 생성
            updateMonthYear();
            generateCalendar();
            renderEvents(scheduleList);

            /** 캘린더 관련 함수 */
            function updateMonthYear() {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth() + 1;
                $('#current-month-year').text(`${year}년 ${month}월`);
            }

            let currentFilter = 'all'; // 현재 필터 상태

            function generateCalendar() {
                const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getDay();
                const lastDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
                const prevLastDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 0).getDate();

                const today = new Date(); // 오늘 날짜 객체 생성
                const todayDate = today.getDate();
                const isCurrentMonth = currentDate.getFullYear() === today.getFullYear() && currentDate.getMonth() === today.getMonth();

                $('.calendar-body').html(''); // 캘린더 내용 초기화
                let date = 1;
                let isLastDateDisplayed = false;

                for (let i = 0; i < 6; i++) {
                    const row = document.createElement('tr');

                    for (let j = 0; j < 7; j++) {
                        const cell = document.createElement('td');
                        cell.classList.add('calendar-cell');

                        if (i === 0 && j < firstDay) {
                            const prevDate = prevLastDate - (firstDay - j - 1);
                            cell.textContent = prevDate;
                            cell.classList.add('prev-month-cell');
                            cell.style.color = '#aaaaaa';
                            cell.style.backgroundColor = '#f0f0f0';
                        } else if (date <= lastDate) {
                            cell.innerHTML = `<div class="calendar-date">${date}</div>`;

                            // 오늘 날짜 강조
                            if (isCurrentMonth && date === todayDate) {
                                const calendarDateDiv = cell.querySelector('.calendar-date');
                                calendarDateDiv.style.backgroundColor = '#CC0000';
                                calendarDateDiv.style.color = '#ffffff';
                                calendarDateDiv.style.width = '30px';
                                calendarDateDiv.style.height = '30px';
                                calendarDateDiv.style.display = 'flex';
                                calendarDateDiv.style.marginLeft = '-5px';
                                calendarDateDiv.style.justifyContent = 'center';
                                calendarDateDiv.style.alignItems = 'center';
                                calendarDateDiv.style.borderRadius = '50%';
                                calendarDateDiv.style.paddingRight = '5px';
                                calendarDateDiv.style.paddingLeft = '5px';
                                calendarDateDiv.style.marginTop = '-5px';

                            }


                            if (date === lastDate) {
                                isLastDateDisplayed = true;
                            }

                            date++;
                        } else {
                            const nextDate = date - lastDate;
                            cell.textContent = nextDate;
                            cell.classList.add('next-month-cell');
                            cell.style.color = '#aaaaaa';
                            cell.style.backgroundColor = '#f0f0f0';
                            date++;
                        }

                        row.appendChild(cell);
                    }

                    $('.calendar-body').append(row);

                    if (isLastDateDisplayed && i === 4) {
                        break;
                    }
                }
            }

            function renderEvents(events) {
                $('.calendar-body .calendar-cell').each(function () {
                    const dateElement = $(this).find('.calendar-date');
                    if (dateElement.length) {
                        const dateText = dateElement.text().padStart(2, '0');
                        const currentFormattedDate = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${dateText}`;

                        // 해당 날짜의 이벤트 필터링
                        let dayEvents = events.filter(event =>
                            event.calendar_event_bgn_date.startsWith(currentFormattedDate) &&
                            (event.calendar_type === '1' || event.calendar_type === '2')
                        );

                        // 종일 이벤트와 일반 이벤트를 분리
                        const allDayEvents = dayEvents.filter(event => event.calendar_is_all_day === 'Y');
                        const timedEvents = dayEvents.filter(event => event.calendar_is_all_day !== 'Y');

                        // 이벤트 렌더링 순서: 종일 이벤트 먼저, 일반 이벤트 다음
                        const eventsToRender = [...allDayEvents, ...timedEvents];

                        // 이벤트 추가
                        eventsToRender.forEach(event => {
                            const eventClass = event.calendar_is_all_day === 'Y'
                                ? (event.calendar_type === '1' ? 'event-bar-team-allday' : 'event-bar-personal-allday')
                                : (event.calendar_type === '1' ? 'event-bar-team' : 'event-bar-personal');

                            const dotClass = event.calendar_type === '2' ? 'event-dot-personal' : 'event-dot-team';

                            const $eventElement = $(`
                <div class="${eventClass}" data-calendar-sn="${event.calendar_sn}"
                     data-title="${event.calendar_event_title}"
                     data-date="${event.calendar_event_bgn_date}"
                     data-location="${event.calendar_event_location || ''}">
                    ${event.calendar_is_all_day === 'Y'
                                    ? `${event.calendar_event_title || '제목 없음'}`
                                    : `<span class="${dotClass}"></span>${event.calendar_event_title || '제목 없음'}`
                                }
                </div>
            `);

                            // task_checked_val이 true인 경우 스타일 강제 적용
                            if (event.task_checked_val) {
                                if (eventClass.includes('allday')) {
                                    // 종일 이벤트 배경색 설정
                                    $eventElement.css('background-color', '#ababab');
                                } else {
                                    // 일반 이벤트 dot 색상 설정
                                    const dot = $eventElement.find('.event-dot-team, .event-dot-personal');
                                    if (dot.length) {
                                        dot.css('background-color', '#ababab');
                                    }
                                }
                            }

                            $(this).append($eventElement);
                            console.log(`Rendering Event: calendar_sn=${event.calendar_sn}, task_checked_val=${event.task_checked_val}`);
                        });
                    }
                });
            }



            function updateCalendarStyles() {
                const checkedCalendarSn = $('.today-tasks-list input[type="checkbox"]:checked')
                    .closest('.today-tasks')
                    .map(function () {
                        return $(this).data('calendar-sn');
                    })
                    .get();

                console.log('Checked Calendar SN:', checkedCalendarSn);

                $('.event-bar-team, .event-bar-personal, .event-bar-team-allday, .event-bar-personal-allday').css({
                    'background-color': ''
                }).find('.event-dot-team, .event-dot-personal').css({
                    'background-color': ''
                });

                checkedCalendarSn.forEach(sn => {
                    $(`.event-bar-team[data-calendar-sn="${sn}"],
       .event-bar-personal[data-calendar-sn="${sn}"],
       .event-bar-team-allday[data-calendar-sn="${sn}"],
       .event-bar-personal-allday[data-calendar-sn="${sn}"]`).each(function () {
                        if ($(this).hasClass('event-bar-team-allday') || $(this).hasClass('event-bar-personal-allday')) {
                            $(this).css('background-color', '#ababab');
                        } else {
                            const dot = $(this).find('.event-dot-team, .event-dot-personal');
                            if (dot.length) {
                                dot.css('background-color', '#ababab');
                            }
                        }
                    });
                });
            }

            // 체크박스 이벤트 핸들러
            $('.today-tasks input[type="checkbox"]').on('change', function () {
                updateCalendarStyles(); // 체크박스 변경 후 스타일 동기화
            });

            // 체크박스 변경 이벤트 핸들러
            $('.today-tasks-list').on('change', 'input[type="checkbox"]', function () {
                const taskContainer = $(this).closest('.today-tasks');
                const calendarSn = taskContainer.data('calendar-sn');
                const taskCheckedVal = $(this).is(':checked');

                console.log(`Checkbox Changed: Calendar SN: ${calendarSn}, Checked: ${taskCheckedVal}`);

                // AJAX 요청으로 상태 업데이트
                $.ajax({
                    type: 'POST',
                    url: '/schedule/personal/update-task-status',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        calendar_sn: calendarSn,
                        task_checked_val: taskCheckedVal
                    }),
                    beforeSend: function (xhr) {
                        const csrfHeader = $('meta[name="_csrf_header"]').attr('content');
                        const csrfToken = $('meta[name="_csrf"]').attr('content');
                        xhr.setRequestHeader(csrfHeader, csrfToken);
                    },
                    success: function () {
                        console.log('Task status updated successfully.');
                        updateCalendarStyles(); // 스타일 업데이트 함수 호출 (필요 시 추가)
                    },
                    error: function (xhr) {
                        console.error('Failed to update task status:', xhr.responseText);
                    }
                });
            });


            function applyFilter(filter) {
                if (filter === 'team') {
                    $('.event-bar-team, .event-bar-team-allday').show();
                    $('.event-bar-personal, .event-bar-personal-allday').hide();
                } else if (filter === 'personal') {
                    $('.event-bar-personal, .event-bar-personal-allday').show();
                    $('.event-bar-team, .event-bar-team-allday').hide();
                } else {
                    $('.event-bar-team, .event-bar-personal, .event-bar-team-allday, .event-bar-personal-allday').show();
                }
            }

            $('#schedule_team_btn').on('click', function () {
                currentFilter = 'team';
                applyFilter(currentFilter);
            });

            $('#schedule_personal_btn').on('click', function () {
                currentFilter = 'personal';
                applyFilter(currentFilter);
            });

            $('#schedule_all_btn').on('click', function () {
                currentFilter = 'all';
                applyFilter(currentFilter);
            });

            updateMonthYear();
            generateCalendar();
            renderEvents(scheduleList);




            $('#btn_left').on('click', function () {
                currentDate.setMonth(currentDate.getMonth() - 1);
                updateMonthYear();
                generateCalendar();
                renderEvents(scheduleList);
                applyFilter(currentFilter);
            });

            $('#btn_right').on('click', function () {
                currentDate.setMonth(currentDate.getMonth() + 1);
                updateMonthYear();
                generateCalendar();
                renderEvents(scheduleList);
                applyFilter(currentFilter);
            });

            /** 필터 버튼 이벤트 */
            $('#schedule_team_btn').on('click', function () {
                // 팀 이벤트(1)와 종일 팀 이벤트 필터링
                $('.event-bar-team, .event-bar-team-allday').show(); // 팀 이벤트만 표시
                $('.event-bar-personal, .event-bar-personal-allday').hide(); // 개인 이벤트 숨김
            });

            $('#schedule_personal_btn').on('click', function () {
                // 개인 이벤트(2)와 종일 개인 이벤트 필터링
                $('.event-bar-personal, .event-bar-personal-allday').show(); // 개인 이벤트만 표시
                $('.event-bar-team, .event-bar-team-allday').hide(); // 팀 이벤트 숨김
            });

            $('#schedule_all_btn').on('click', function () {
                // 모든 이벤트 표시
                $('.event-bar-team, .event-bar-personal, .event-bar-team-allday, .event-bar-personal-allday').show();
            });

            /** 모달 관련 기능 */
            const $scheduleModal = $('.schedule_detail');
            const $eventModal = $('.event-card');
            const $currentDateSpan = $('#current-date');
            let modalSelectedDate = new Date();


            function closeAllModals() {
                $scheduleModal.fadeOut();
                $eventModal.fadeOut();
            }
            function formatDate(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0'); // 월은 0부터 시작하므로 +1
                const day = String(date.getDate()).padStart(2, '0'); // 날짜
                return `${year}-${month}-${day}`;
            }

            function updateModalDateDisplay() {
                const formattedDate = formatDate(modalSelectedDate);
                $currentDateSpan.text(formattedDate); // 모달에 날짜 표시
            }
            updateModalDateDisplay();


            $('#prev-day').on('click', function () {
                modalSelectedDate.setDate(modalSelectedDate.getDate() - 1); // 하루 전으로 이동
                updateModalDateDisplay(); // 날짜 업데이트
            });

            // 다음 날짜 버튼 클릭 이벤트
            $('#next-day').on('click', function () {
                modalSelectedDate.setDate(modalSelectedDate.getDate() + 1); // 하루 후로 이동
                updateModalDateDisplay(); // 날짜 업데이트
            });

            // 모달이 열릴 때 현재 날짜를 설정 (필요 시 추가)
            $('.schedule_detail').on('show', function () {
                modalSelectedDate = new Date(); // 모달이 열릴 때 현재 날짜로 초기화
                updateModalDateDisplay();
            });

            $('.calendar-body').on('click', '.calendar-cell', function (event) {
                const $target = $(event.target);
                const $dateElement = $(this).find('.calendar-date'); // 클릭한 셀의 날짜 요소


                // 이벤트 바 클릭 시 일정 등록 모달 열리지 않음
                if ($target.closest('.event-bar-team, .event-bar-personal, .event-bar-allday').length > 0) {
                    return; // 이벤트 바를 클릭했으면 일정 등록 모달 열지 않음
                }
                if ($eventModal.is(':visible')) {
                    $eventModal.fadeOut();
                }

                if ($dateElement.length) {
                    const selectedDate = parseInt($dateElement.text()); // 선택된 날짜 숫자 가져오기
                    const year = currentDate.getFullYear();
                    const month = currentDate.getMonth(); // 현재 월 (0부터 시작)
                    modalSelectedDate = new Date(year, month, selectedDate); // 선택된 날짜 설정
                    updateModalDateDisplay(); // 모달에 선택된 날짜 표시
                }


                // 모달 위치 설정
                const clickX = event.pageX;
                const clickY = event.pageY;
                $scheduleModal.css({
                    display: 'block',
                    top: clickY + 'px',
                    left: clickX + 'px',
                    position: 'absolute',
                    transform: 'translate(-50%, -50%)'
                }).fadeIn();
            });

            // 일정 등록 모달 닫기
            $('.schedule_detail .close').on('click', function () {
                $scheduleModal.fadeOut();
            });

            // 윈도우 클릭 시 모달 닫기
            $(window).on('click', function (event) {
                if ($(event.target).is($scheduleModal)) {
                    $scheduleModal.fadeOut();
                }
                if ($(event.target).is($eventModal)) {
                    $eventModal.fadeOut();
                }
            });

            $('.calendar-body').on('click', '.event-bar-team, .event-bar-personal, .event-bar-team-allday, .event-bar-personal-allday', function (event) {
                // 이벤트 전파 방지
                event.stopPropagation();
                const calendarSn = $(this).data('calendar-sn');
                $('.event-card').data('calendar-sn', calendarSn);
                // 클릭된 이벤트 데이터 추출
                const $target = $(event.currentTarget);
                const title = $target.data('title') || '제목 없음';
                const date = $target.data('date') || '시간 없음';
                const location = $target.data('location') || '위치 없음';
                const detail = $target.data('detail') || '세부 정보 없음';
                const isAllDay = $target.hasClass('event-bar-team-allday') || $target.hasClass('event-bar-personal-allday');

                console.log(`Clicked Event Data: Title=${title}, Date=${date}, Location=${location}, AllDay=${isAllDay}`);

                // 시간 형식 변환 (UTC -> 로컬)
                let formattedDate = date;
                if (date && !isAllDay) {
                    const originalDate = new Date(date);
                    originalDate.setHours(originalDate.getHours() + 9); // 9시간 추가
                    formattedDate = `${originalDate.getFullYear()}-${String(originalDate.getMonth() + 1).padStart(2, '0')}-${String(originalDate.getDate()).padStart(2, '0')} ${String(originalDate.getHours()).padStart(2, '0')}:${String(originalDate.getMinutes()).padStart(2, '0')}`;
                }

                // 모달에 데이터 추가
                const $eventModal = $('.event-card');
                $eventModal.find('.event-title').text(title);
                $eventModal.find('.event-time').text(isAllDay ? '종일' : formattedDate);
                $eventModal.find('.event-location').text(location);
                $eventModal.find('.event-memo').text(detail);

                // 모달 위치 설정
                const clickX = event.pageX;
                const clickY = event.pageY;
                $eventModal.css({
                    display: 'block',
                    top: clickY + 'px',
                    left: clickX + 'px',
                    position: 'absolute',
                    transform: 'translate(-50%, 5%)'
                }).fadeIn();
            });

            // 모달 닫기 버튼
            $('.close-event').on('click', function () {
                $('.event-card').fadeOut();
            });
            $(document).on('click', '.task_etc', function (event) {
                // 이벤트 전파 방지
                event.stopPropagation();

                // 클릭한 오늘의 할 일에서 데이터 추출
                const $taskContainer = $(this).closest('.today-tasks');
                const title = $taskContainer.find('#task_text p').text() || '제목 없음';
                const calendarSn = $taskContainer.data('calendar-sn') || 'N/A';
                const isAllDay = $taskContainer.data('is-all-day') === 'Y'; // 종일 여부
                const date = $taskContainer.data('date');
                const location = $taskContainer.data('location') || '위치 없음';
                const detail = $taskContainer.data('detail') || '세부 정보 없음';

                console.log(`Task Data: Title=${title}, Calendar SN=${calendarSn}, Date=${date}, Location=${location}, AllDay=${isAllDay}`);
                $('.event-card').data('calendar-sn', calendarSn);

                // 시간 변환 (UTC -> 로컬 시간, 종일 제외)
                let formattedDate = date || '시간 없음';
                if (date && !isAllDay) {
                    const originalDate = new Date(date);
                    originalDate.setHours(originalDate.getHours() + 9); // 9시간 추가
                    formattedDate = `${originalDate.getFullYear()}-${String(originalDate.getMonth() + 1).padStart(2, '0')}-${String(originalDate.getDate()).padStart(2, '0')} ${String(originalDate.getHours()).padStart(2, '0')}:${String(originalDate.getMinutes()).padStart(2, '0')}`;
                }

                // 모달에 데이터 추가
                const $eventModal = $('.event-card');
                $eventModal.find('.event-title').text(title);
                $eventModal.find('.event-time').text(isAllDay ? '종일' : formattedDate);
                $eventModal.find('.event-location').text(location);
                $eventModal.find('.event-memo').text(detail);

                // 모달 위치 설정
                const clickX = event.pageX; // 클릭한 X 좌표
                const clickY = event.pageY; // 클릭한 Y 좌표
                $eventModal.css({
                    display: "block",
                    top: clickY + "px",
                    left: clickX + "px",
                    position: "absolute",
                    transform: "translate(-90%, 12%)"
                }).fadeIn();
            });

            // 모달 닫기 이벤트
            $('.close-event').on('click', function () {
                $('.event-card').fadeOut();
            });
            // 상위 요소의 클릭 이벤트 처리 방지
            $('.calendar-body').on('click', function (event) {
                // 여기서는 아무 작업도 하지 않음
                event.stopPropagation();
            });

            // 윈도우 클릭 시 모달 닫기
            $(window).on('click', function (event) {
                if ($(event.target).is($scheduleModal)) {
                    $scheduleModal.fadeOut();
                }
                if ($(event.target).is($eventModal)) {
                    $eventModal.fadeOut();
                }
            });


            const timeSelect = document.getElementById('time-select');
            for (let i = 0; i < 48; i++) {
                const hour = Math.floor(i / 2).toString().padStart(2, '0'); // 시간 계산
                const minute = (i % 2 === 0 ? '00' : '30'); // 분 계산
                const option = document.createElement('option');
                option.value = `${hour}:${minute}`;
                option.textContent = `${hour}:${minute}`;
                timeSelect.appendChild(option);
            }
            $('.close-event').on('click', function () {
                $eventModal.fadeOut();
            });

            $('.today-tasks input[type="checkbox"]').on('change', function () {
                const taskContainer = $(this).closest('.today-tasks');
                if ($(this).is(':checked')) {
                    taskContainer.css('background-color', '#ababab');
                } else {
                    taskContainer.css('background-color', '#f8f9fa');
                }
            });
            document.querySelectorAll('.select-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    if (this.checked) {
                        document.querySelectorAll('.select-checkbox').forEach(otherCheckbox => {
                            if (otherCheckbox !== this) {
                                otherCheckbox.checked = false;
                            }
                        });
                    }
                });
            });

            // "팀"과 "개인" 체크박스는 하나만 선택 가능, "종일"은 독립적으로 동작
            $('.select-checkbox').on('change', function () {
                const id = $(this).attr('id');

                if (id === 'team-team' || id === 'team-personal') {
                    // 팀과 개인은 서로 배타적으로 동작
                    $('#team-team, #team-personal').not(this).prop('checked', false);
                }
            });


         // UTC 시간을 기준으로 9시간 빼는 함수
function subtractNineHours(dateString) {
    const date = new Date(dateString); // 입력된 날짜 문자열을 Date 객체로 변환
    const utcOffset = 9 * 60 * 60 * 1000; // 9시간 (밀리초 단위)
    const adjustedDate = new Date(date.getTime() - utcOffset); // 9시간 빼기

    const year = adjustedDate.getFullYear();
    const month = String(adjustedDate.getMonth() + 1).padStart(2, '0');
    const day = String(adjustedDate.getDate()).padStart(2, '0');
    const hours = String(adjustedDate.getHours()).padStart(2, '0');
    const minutes = String(adjustedDate.getMinutes()).padStart(2, '0');
    const seconds = String(adjustedDate.getSeconds()).padStart(2, '0');

    return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`; // YYYY-MM-DD HH:mm:ss 형식 반환
}

// 등록 버튼 클릭 시 데이터 처리
$('#submit_btn').on('click', function () {
    const modalDate = $('#current-date').text(); // 모달의 날짜
    const selectedTime = $('#time-select').val(); // 선택된 시간

    let combinedDateTime = null;

    if (modalDate && selectedTime) {
        combinedDateTime = `${modalDate} ${selectedTime}:00`; // 초(:00) 추가
        console.log("Combined DateTime (Before Adjustment):", combinedDateTime);

        // 9시간 빼기
        combinedDateTime = subtractNineHours(combinedDateTime);
        console.log("Combined DateTime (Adjusted):", combinedDateTime);
    } else {
        console.error("Error: Missing modalDate or selectedTime.");
        alert("날짜와 시간을 선택하세요.");
        return;
    }

    const userId = /*[[${user_id}]]*/ ''; // user_id 가져오기
    const eventTitle = $('.task-title').val();
    const eventLocation = $('.location-input').val();
    const eventDetail = $('.details-input').val();

    // "팀"인지 "개인"인지 확인
    const eventType = $('#team-team').is(':checked') ? '1' : ($('#team-personal').is(':checked') ? '2' : null);
    if (!eventType) {
        alert("팀 또는 개인을 선택하세요.");
        return;
    }

    // "종일" 체크 여부
    const isAllDay = $('#event-allday').is(':checked') ? 'Y' : 'N';

    // 디버깅 로그
    console.log("User ID:", userId);
    console.log("Event Title:", eventTitle);
    console.log("Event Location:", eventLocation);
    console.log("Event Detail:", eventDetail);
    console.log("Event Type:", eventType);
    console.log("Calendar is All Day:", isAllDay);

    if (!eventTitle) {
        alert("제목을 입력하세요.");
        return;
    }

    const now = new Date();
    const createdAt = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;

    // AJAX 요청
    $.ajax({
        type: "POST",
        url: "/schedule/personal/register",
        contentType: "application/json",
        data: JSON.stringify({
            user_id: userId, // user_id 전달
            calendar_event_bgn_date: combinedDateTime, // 9시간 뺀 시간 저장
            calendar_create_at: createdAt, // 일정이 추가된 시간
            calendar_event_title: eventTitle, // 제목
            calendar_event_location: eventLocation, // 장소
            calendar_type: eventType, // 팀 또는 개인
            calendar_event_detail: eventDetail, // 상세 정보
            calendar_is_all_day: isAllDay // 종일 여부
        }),
        beforeSend: function (xhr) {
            const csrfHeader = $('meta[name="_csrf_header"]').attr('content');
            const csrfToken = $('meta[name="_csrf"]').attr('content');
            xhr.setRequestHeader(csrfHeader, csrfToken); // CSRF 헤더 추가
        },
        success: function () {
            alert("일정이 성공적으로 등록되었습니다.");
            location.reload();
        },
        error: function (xhr) {
            console.error("일정 등록 실패:", xhr.responseText);
            alert("일정 등록에 실패했습니다.");
        }
    });
});

            function getTodayDate() {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0'); // 월은 0부터 시작하므로 +1
                const day = String(today.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            function addNineHoursToUTC(utcDate) {
                const date = new Date(utcDate); // UTC 시간 기준으로 생성
                date.setHours(date.getHours() + 9); // 9시간 추가
                return date;
            }
            // 오늘의 일정 렌더링
            function renderTodayTasks(events) {
                const todayFormatted = formatDate(new Date());
                const currentUserId = /*[[${user_id}]]*/ ''; // 현재 로그인된 user_id 가져오기

                // 오늘의 일정 필터링: 날짜, user_id, calendar_type 조건 추가
                const todayEvents = events.filter(event => {
                    const eventDate = addNineHoursToUTC(event.calendar_event_bgn_date).toISOString().split('T')[0];
                    return (
                        eventDate === todayFormatted &&
                        event.user_id === currentUserId &&
                        (event.calendar_type === '1' || event.calendar_type === '2') // calendar_type이 1 또는 2
                    );
                });

                const $todayTaskContainer = $('.today_task .today-tasks-list');
                $todayTaskContainer.empty();

                if (todayEvents.length === 0) {
                    $todayTaskContainer.append('<p>오늘 일정이 없습니다.</p>');
                    return;
                }

                todayEvents.forEach(event => {
                    let time = '종일';
                    if (event.calendar_is_all_day !== 'Y') {
                        const localDate = addNineHoursToUTC(event.calendar_event_bgn_date);
                        time = localDate.toTimeString().substring(0, 5); // HH:mm 추출
                    }

                    const $taskElement = $(`
       <div class="today-tasks"
            data-calendar-sn="${event.calendar_sn}"
            data-is-all-day="${event.calendar_is_all_day}"
            data-date="${event.calendar_event_bgn_date || ''}"
            data-location="${event.calendar_event_location || ''}"
            data-detail="${event.calendar_event_detail || ''}">
            <label><strong>&middot; ${time}</strong></label>
            <button class="delete-task">
                <img id="delete" src="/css/schedule/img/delete.png" alt="Delete">
            </button>
            <button class="task_etc"><img id="task_etc_btn" src="/css/schedule/img/memo.png" alt="memo"></button>
            <div id="task_text">
                <p>${event.calendar_event_title || '제목 없음'}</p>
                <input type="checkbox">
            </div>
        </div>
    `);
                    $todayTaskContainer.append($taskElement);
                });

                console.log('Today Tasks Rendered:', $todayTaskContainer);
            }


            // 초기화 시 호출
            console.log("Schedule List on load:", scheduleList); // 디버깅용
            renderTodayTasks(scheduleList);

            // 체크박스 색상 변경
            document.querySelectorAll('.today-tasks input[type="checkbox"]').forEach((checkbox) => {
                checkbox.addEventListener('change', function () {
                    const taskContainer = this.closest('.today-tasks');
                    if (this.checked) {
                        taskContainer.style.backgroundColor = '#ababab';
                    } else {
                        taskContainer.style.backgroundColor = '#f8f9fa';
                    }
                });
            });
            $('.today-tasks').each(function () {
                console.log('Today Task Calendar SN:', $(this).data('calendar-sn'));
            });
            $('.event-bar-team, .event-bar-personal, .event-bar-team-allday, .event-bar-personal-allday').each(function () {
                console.log('Calendar Event Calendar SN:', $(this).data('calendar-sn'));
            });
            $('.today-tasks input[type="checkbox"]').on('change', function () {
                const taskContainer = $(this).closest('.today-tasks');
                const calendarSn = taskContainer.data('calendar-sn'); // today-tasks의 calendar_sn 가져오기
                console.log('Checkbox Changed: Calendar SN:', calendarSn, 'Checked:', $(this).is(':checked'));
            });

            $(document).on('click', '.delete-task', function (event) {
                event.stopPropagation(); // 이벤트 전파 방지

                // 해당 task의 calendar_sn 가져오기
                const $taskContainer = $(this).closest('.today-tasks');
                const calendarSn = $taskContainer.data('calendar-sn');

                if (!calendarSn) {
                    console.error('Calendar SN is missing!');
                    return;
                }

                // 확인 메시지
                const confirmDelete = confirm('정말로 이 일정을 삭제하시겠습니까?');
                if (!confirmDelete) return;

                console.log(`Deleting Task: Calendar SN=${calendarSn}`);

                // AJAX 요청으로 데이터 삭제
                $.ajax({
                    type: 'POST',
                    url: '/schedule/personal/delete-task', // 삭제 API 엔드포인트
                    contentType: 'application/json',
                    data: JSON.stringify({ calendar_sn: calendarSn }),
                    beforeSend: function (xhr) {
                        const csrfHeader = $('meta[name="_csrf_header"]').attr('content'); // CSRF 헤더 이름
                        const csrfToken = $('meta[name="_csrf"]').attr('content'); // CSRF 토큰 값
                        xhr.setRequestHeader(csrfHeader, csrfToken); // CSRF 헤더 설정
                    },
                    success: function () {
                        console.log('Task deleted successfully.');

                        // 화면에서 해당 Task 제거
                        $taskContainer.fadeOut(300, function () {
                            $(this).remove();
                        });
                    },
                    error: function (xhr) {
                        console.error('Failed to delete task:', xhr.responseText);
                        alert('일정 삭제에 실패했습니다.');
                    }
                });
            });
        });
        $(document).ready(function () {
            const scheduleList = /*[[${personalScheduleList}]]*/[]; // 서버에서 전달받은 일정 데이터

            // 오늘 날짜를 기반으로 #today-date를 동적으로 생성
            function initializeTodayDate() {
                const today = new Date();
                updateTodayDate(today); // 오늘 날짜로 초기화
            }

            // #today-date 업데이트 함수
            function updateTodayDate(date) {
                const daysOfWeek = ['일', '월', '화', '수', '목', '금', '토']; // 요일 배열
                const dayOfWeek = daysOfWeek[date.getDay()]; // 현재 날짜의 요일 가져오기

                const formattedDate = `${String(date.getMonth() + 1).padStart(2, '0')}월 ${String(date.getDate()).padStart(2, '0')}일 (${dayOfWeek})`;
                $('#today-date').text(formattedDate).data('current-date', date.toISOString().split('T')[0]); // 날짜와 ISO 포맷 저장
            }

            // 오늘의 일정 렌더링
            function renderTodayTasks(events) {
                const todayDateText = $('#today-date').data('current-date'); // ISO 형식 날짜 가져오기
                const currentUserId = /*[[${user_id}]]*/ ''; // 현재 로그인된 user_id 가져오기

                // 오늘의 일정 필터링: 날짜, user_id, calendar_type 조건 추가
                const todayEvents = events.filter(event => {
                    const eventDate = addNineHoursToUTC(event.calendar_event_bgn_date).toISOString().split('T')[0];
                    return (
                        eventDate === todayDateText &&
                        event.user_id === currentUserId &&
                        (event.calendar_type === '1' || event.calendar_type === '2') // calendar_type이 1 또는 2
                    );
                });

                // calendar_is_all_day가 Y인 데이터를 우선적으로 정렬
                todayEvents.sort((a, b) => {
                    if (a.calendar_is_all_day === 'Y' && b.calendar_is_all_day !== 'Y') return -1;
                    if (a.calendar_is_all_day !== 'Y' && b.calendar_is_all_day === 'Y') return 1;
                    return 0; // 순서 유지
                });

                const $todayTaskContainer = $('.today_task .today-tasks-list');
                $todayTaskContainer.empty();

                if (todayEvents.length === 0) {
                    $todayTaskContainer.append('<p class="no-tasks-message">오늘 일정이 없습니다.</p>');
                    return;
                }

                todayEvents.forEach(event => {
                    let time = '종일';
                    if (event.calendar_is_all_day !== 'Y') {
                        const localDate = addNineHoursToUTC(event.calendar_event_bgn_date);
                        time = localDate.toTimeString().substring(0, 5); // HH:mm 추출
                    }

                    // task_checked_val이 true인 경우 체크 상태 추가
                    const isChecked = event.task_checked_val ? 'checked' : '';

                    const $taskElement = $(`
        <div class="today-tasks"
            data-calendar-sn="${event.calendar_sn}"
            data-is-all-day="${event.calendar_is_all_day}"
            data-date="${event.calendar_event_bgn_date || ''}"
            data-location="${event.calendar_event_location || ''}"
            data-detail="${event.calendar_event_detail || ''}">
            <label><strong>&middot; ${time}</strong></label>
            <button class="delete-task">
                <img id="delete" src="/css/schedule/img/delete.png" alt="Delete">
            </button>
            <button class="task_etc"><img id="task_etc_btn" src="/css/schedule/img/memo.png" alt="memo"></button>
            <div id="task_text">
                <p>${event.calendar_event_title || '제목 없음'}</p>
                <input type="checkbox" ${isChecked}>
            </div>
        </div>
    `);
                    $todayTaskContainer.append($taskElement);
                });

                console.log('Today Tasks Rendered:', $todayTaskContainer);

                // **체크박스 상태를 기반으로 초기 스타일 설정**
                applyCheckboxStyles();
            }

            // 날짜 이동 버튼 처리
            $('#prev-day-btn').on('click', () => {
                const currentDate = new Date($('#today-date').data('current-date')); // data로 저장된 현재 날짜 가져오기
                currentDate.setDate(currentDate.getDate() - 1); // 하루 전으로 이동

                updateTodayDate(currentDate); // #today-date 업데이트
                renderTodayTasks(scheduleList); // 이동 후 일정 렌더링
            });

            $('#next-day-btn').on('click', () => {
                const currentDate = new Date($('#today-date').data('current-date')); // data로 저장된 현재 날짜 가져오기
                currentDate.setDate(currentDate.getDate() + 1); // 하루 후로 이동

                updateTodayDate(currentDate); // #today-date 업데이트
                renderTodayTasks(scheduleList); // 이동 후 일정 렌더링
            });

            // UTC 날짜에 9시간 더하기
            function addNineHoursToUTC(utcDate) {
                const date = new Date(utcDate); // UTC 시간 기준으로 생성
                date.setHours(date.getHours() + 9); // 9시간 추가
                return date;
            }

            // 날짜 포맷팅 함수
            function formatDate(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0'); // 월은 0부터 시작하므로 +1
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            // 초기화

            initializeTodayDate(); // 오늘 날짜로 초기화
            renderTodayTasks(scheduleList); // 초기 일정 렌더링
            function applyCheckboxStyles() {
                $('.today-tasks-list input[type="checkbox"]').each(function () {
                    const taskContainer = $(this).closest('.today-tasks');
                    if ($(this).is(':checked')) {
                        taskContainer.css('background-color', '#ababab'); // 체크된 스타일
                    } else {
                        taskContainer.css('background-color', '#f8f9fa'); // 기본 스타일
                    }
                });
            }

            // 체크박스 상태 변경 이벤트 (이벤트 위임 방식)
            $('.today-tasks-list').on('change', 'input[type="checkbox"]', function () {
                const taskContainer = $(this).closest('.today-tasks');
                const calendarSn = taskContainer.data('calendar-sn');
                const taskCheckedVal = $(this).is(':checked');

                console.log(`Checkbox Changed: Calendar SN: ${calendarSn}, Checked: ${taskCheckedVal}`);

                // AJAX 요청으로 상태 업데이트
                $.ajax({
                    type: 'POST',
                    url: '/schedule/personal/update-task-status',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        calendar_sn: calendarSn,
                        task_checked_val: taskCheckedVal
                    }),
                    beforeSend: function (xhr) {
                        const csrfHeader = $('meta[name="_csrf_header"]').attr('content');
                        const csrfToken = $('meta[name="_csrf"]').attr('content');
                        xhr.setRequestHeader(csrfHeader, csrfToken);
                    },
                    success: function () {
                        console.log('Task status updated successfully.');
                        applyCheckboxStyles(); // 변경된 상태 반영
                    },
                    error: function (xhr) {
                        console.error('Failed to update task status:', xhr.responseText);
                    }
                });
            });

            // 페이지 로드 시 초기화
            $(document).ready(function () {
                renderTodayTasks(/*[[${events}]]*/); // 서버에서 전달된 일정 데이터 사용
                applyCheckboxStyles(); // 초기 스타일 적용
            });

            $(document).on('click', '#delete_btn', function (event) {
                event.stopPropagation(); // 이벤트 전파 방지

                // 모달에서 삭제할 데이터 식별자(calendar_sn) 가져오기
                const $eventModal = $('.event-card');
                const calendarSn = $eventModal.data('calendar-sn');

                if (!calendarSn) {
                    console.error('Calendar SN is missing!');
                    return;
                }

                // 삭제 확인
                const confirmDelete = confirm('정말로 이 일정을 삭제하시겠습니까?');
                if (!confirmDelete) return;

                console.log(`Deleting Event: Calendar SN=${calendarSn}`);

                // AJAX 요청으로 데이터 삭제
                $.ajax({
                    type: 'POST',
                    url: '/schedule/personal/delete-task', // 삭제 API 엔드포인트
                    contentType: 'application/json',
                    data: JSON.stringify({ calendar_sn: calendarSn }),
                    beforeSend: function (xhr) {
                        const csrfHeader = $('meta[name="_csrf_header"]').attr('content');
                        const csrfToken = $('meta[name="_csrf"]').attr('content');
                        xhr.setRequestHeader(csrfHeader, csrfToken);
                    },
                    success: function () {
                        console.log('Event deleted successfully.');

                        // 모달 닫기
                        $eventModal.fadeOut();

                        // 캘린더와 할 일 리스트에서 해당 항목 제거
                        $(`.event-bar-team[data-calendar-sn="${calendarSn}"],
           .event-bar-personal[data-calendar-sn="${calendarSn}"],
           .event-bar-team-allday[data-calendar-sn="${calendarSn}"],
           .event-bar-personal-allday[data-calendar-sn="${calendarSn}"]`).remove();

                        $(`.today-tasks[data-calendar-sn="${calendarSn}"]`).remove();
                    },
                    error: function (xhr) {
                        console.error('Failed to delete event:', xhr.responseText);
                        alert('일정 삭제에 실패했습니다.');
                    }
                });
            });

        });

    </script>




</div>
</body>

</html>