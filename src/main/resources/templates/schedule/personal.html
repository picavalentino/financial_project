<!DOCTYPE html>
<html xmlns:th="www.thymeleaf.org" xmlns:layout="www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/layout}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>개인 일정 관리</title>
    <link rel="stylesheet" th:href="@{/css/schedule/personal.css}">
</head>

<body>
<div layout:fragment="content" class="content">
    <div class="container1">
        <div class="content1">
            <div class="calendar-container">
                <div class="calendar-header">
                    <h2>
                        <button id="btn_left">&lt;</button>
                        <span id="current-month-year"></span>
                        <button id="btn_right">&gt;</button>
                    </h2>
                    <div class="button-container">
                        <button id="schedule_all_btn">전체</button>
                        <button id="schedule_team_btn">팀</button>
                        <button id="schedule_personal_btn">개인</button>
                    </div>
                </div>

                <table class="calendar-table">
                    <thead>
                    <tr>
                        <th id="sun">일</th>
                        <th>월</th>
                        <th>화</th>
                        <th>수</th>
                        <th>목</th>
                        <th>금</th>
                        <th id="sat">토</th>
                    </tr>
                    </thead>
                    <tbody class="calendar-body">
                    <!-- 달력 날짜가 JavaScript로 생성됩니다 -->
                    </tbody>
                </table>
            </div>
        </div>
        <div class="today_task">
            <h3>
                <img th:src="@{/css/schedule/img/task_img.png}">
                오늘의 할 일
            </h3>
            <div class="today-tasks">
                <label for="task1"><strong> &middot; 11:30</strong></label>
                <button><img id="delete" th:src="@{/css/schedule/img/delete.png}" alt="Delete"></button>
                <button class="task_etc"><img id="task_etc_btn" th:src="@{/css/schedule/img/memo.png}"
                                              alt="memo"></button>
                <div id="task_text">
                    <p> 점심 미팅 </p><input type="checkbox" id="task1">
                </div>
            </div>
        </div>
    </div>

    <!-- 일정 등록 모달 -->
    <div class="schedule_detail">
        <div class="scheduler-container">
            <h1>일정 등록</h1>
            <div class="date-display">
                <button id="prev-day">&lt;</button>
                <span id="current-date">2024.11.20</span>
                <button id="next-day">&gt;</button>
            </div>
            <div class="scheduler">
                <span class="close">&times;</span>
                <div class="row">
                    <select class="time-select" id="time-select">
                        <!-- Generate time slots dynamically -->
                        <option value="00:00">00:00</option>
                        <option value="23:30">23:30</option>
                    </select>
                    <input type="text" class="task-title" placeholder="Enter title...">
                    <input type="text" class="location-input" placeholder="Enter location...">
                    <div class="checkboxes">
                        <label><input type="checkbox" class="select-checkbox" id="team-team"> 팀 </label>
                        <label><input type="checkbox" class="select-checkbox" id="team-personal"> 개인 </label>
                    </div>
                </div>
                <div class="details">
                    <textarea class="details-input" placeholder="Enter detailed information..."></textarea>
                </div>
                <input type="submit" id="submit_btn" value="등록">
            </div>
        </div>
    </div>

    <!-- 이벤트 카드 모달 -->
    <div class="event-card" style="display:none;">
        <span class="close-event">&times;</span>
        <div class="card-header">
            <h2 class="event-title"></h2>
            <div class="card-actions">
                <button><img id="profile_img" th:src="@{/css/schedule/img/delete.png}" alt="Delete"></button>
                <button><img id="email_img" th:src="@{/css/schedule/img/email.png}" alt="Mail"></button>
            </div>
        </div>
        <div class="card-details">
            <div><img th:src="@{/css/schedule/img/time.png}" alt="time"> <span class="event-time"></span></div>
            <div><img th:src="@{/css/schedule/img/location.png}" alt="place"> <span class="event-location"></span>
            </div>
            <div><img th:src="@{/css/schedule/img/memo.png}" alt="memo"> <span class="event-memo"></span></div>
        </div>
    </div>

    <script th:inline="javascript">
        $(document).ready(function () {
            const $scheduleModal = $('.schedule_detail'); // 일정 등록 모달
            const $eventModal = $('.event-card'); // 이벤트 카드 모달
            const $closeSchedule = $('.schedule_detail .close');
            const $closeEvent = $('.close-event'); // 이벤트 카드 모달 닫기 버튼
            const $currentDateSpan = $('#current-date'); // 모달 내 현재 날짜 표시

            let selectedDate = null; // 선택된 날짜 저장
            let modalSelectedDate = new Date(); // 일정 등록 모달에서 선택된 날짜 저장

            // 다른 모달 닫기
            function closeAllModals() {
                $scheduleModal.fadeOut();
                $eventModal.fadeOut();
            }

            // 일정 등록 모달이 열려 있고, 클릭한 대상이 모달 내부가 아닌 경우 모달 닫기


            // 날짜를 YYYY.MM.DD 형식으로 변환
             function formatDateWithDay(date) {
        const days = ['일요일', '월요일', '화요일', '수요일', '목요일', '금요일', '토요일'];
        const year = date.getFullYear();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        const dayName = days[date.getDay()]; // 요일 계산
        return `${year}.${month}.${day} (${dayName})`;
    }

            // 초기 날짜 표시
    updateModalDateDisplay();

    // 이전 날짜 버튼 클릭
    $('#prev-day').on('click', function () {
        modalSelectedDate.setDate(modalSelectedDate.getDate() - 1); // 하루 감소
        updateModalDateDisplay();
    });

    // 다음 날짜 버튼 클릭
    $('#next-day').on('click', function () {
        modalSelectedDate.setDate(modalSelectedDate.getDate() + 1); // 하루 증가
        updateModalDateDisplay();
    });
            // 일정 등록 모달에서 날짜 업데이트
             function updateModalDateDisplay() {
        const formattedDate = formatDateWithDay(modalSelectedDate);
        $currentDateSpan.text(formattedDate);
    }

            // 날짜 셀 클릭 시 일정 등록 모달 열기
            $('.calendar-body').on("click", '.calendar-cell', function (event) {
                if (
                    $(event.target).hasClass('event-bar-team-allday') ||
                    $(event.target).hasClass('event-bar-personal-allday') ||
                    $(event.target).hasClass('event-bar-personal') ||
                    $(event.target).hasClass('event-bar-team')
                ) {
                    return; // 이벤트 관련 요소 클릭 시 일정 등록 모달 열리지 않음
                }

                const dateElement = $(this).find('.calendar-date'); // 날짜 요소
                if (!dateElement.length) return; // 날짜가 없는 빈 셀 클릭 시 무시

                // 선택된 날짜 설정
                selectedDate = parseInt(dateElement.text());
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth(); // 0부터 시작
                modalSelectedDate = new Date(year, month, selectedDate);

                updateModalDateDisplay(); // 모달 내 날짜 표시 업데이트

                closeAllModals(); // 다른 모달 닫기

                // 모달 위치 설정
                const clickX = event.pageX; // 클릭한 X 좌표
                const clickY = event.pageY; // 클릭한 Y 좌표
                $scheduleModal.css({
                    display: "block",
                    top: clickY + "px",
                    left: clickX + "px",
                    position: "absolute",
                    transform: "translate(-50%, -5%)"
                }).fadeIn();
            });

            // 일정 등록 모달 왼쪽 버튼 클릭: 전날로 이동
            $('#prev-day').on('click', function () {
                modalSelectedDate.setDate(modalSelectedDate.getDate() - 1); // 하루 감소
                updateModalDateDisplay(); // 날짜 업데이트
            });

            // 일정 등록 모달 오른쪽 버튼 클릭: 다음날로 이동
            $('#next-day').on('click', function () {
                modalSelectedDate.setDate(modalSelectedDate.getDate() + 1); // 하루 증가
                updateModalDateDisplay(); // 날짜 업데이트
            });

            // 일정 등록 모달 닫기
            $closeSchedule.on("click", function () {
                $scheduleModal.fadeOut();
            });

            // 이벤트 바 클릭 시 이벤트 카드 모달 열기
            $('.calendar-body').on("click", '.event-bar-team-allday, .event-bar-personal-allday, .event-bar-team, .event-bar-personal', function (event) {
                closeAllModals(); // 다른 모달 닫기

                const $target = $(event.currentTarget); // 클릭된 요소
                const title = $target.data('title');
                const date = $target.data('date');
                const time = $target.data('time');
                const location = $target.data('location');
                const memo = $target.data('memo');

                // 모달 내용 설정
                $('.event-title').text(title);
                $('.event-time').text(`${date} - ${time}`);
                $('.event-location').text(location);
                $('.event-memo').text(memo || "메모 없음");

                // 모달 위치 설정
                const clickX = event.pageX; // 클릭한 X 좌표
                const clickY = event.pageY; // 클릭한 Y 좌표
                $eventModal.css({
                    display: "block",
                    top: clickY + "px",
                    left: clickX + "px",
                    position: "absolute",
                    transform: "translate(-50%, 5%)"
                }).fadeIn();
            });

            // 이벤트 카드 모달 닫기
            $closeEvent.on("click", function () {
                $eventModal.fadeOut();
            });

            // task_etc 버튼 클릭 시 이벤트 모달 열기
            $(document).on('click', '.task_etc', function (event) {
                closeAllModals(); // 다른 모달 닫기

                const taskContainer = $(this).closest('.today-tasks'); // 가장 가까운 부모 요소
                const taskTitle = taskContainer.find('p').text().trim(); // 할 일 제목 가져오기
                const taskTime = taskContainer.find('label strong').text().trim(); // 할 일 시간 가져오기

                // 모달 내용 설정
                $('.event-title').text(taskTitle || "제목 없음");
                $('.event-time').text(taskTime || "시간 없음");
                $('.event-location').text("오늘의 할 일");
                $('.event-memo').text("추가 정보를 입력해주세요");

                // 모달 위치 설정
                const clickX = event.pageX; // 클릭한 X 좌표
                const clickY = event.pageY; // 클릭한 Y 좌표
                $eventModal.css({
                    display: "block",
                    top: clickY + "px",
                    left: clickX + "px",
                    position: "absolute",
                    transform: "translate(-80%, 12%)"
                }).fadeIn();
            });

            // 시간 옵션 동적 생성
            const timeSelect = document.getElementById('time-select');
            for (let i = 0; i < 48; i++) {
                const hour = Math.floor(i / 2).toString().padStart(2, '0'); // 시간 계산
                const minute = (i % 2 === 0 ? '00' : '30'); // 분 계산
                const option = document.createElement('option');
                option.value = `${hour}:${minute}`;
                option.textContent = `${hour}:${minute}`;
                timeSelect.appendChild(option);
            }

            // 모달 외부 클릭 시 닫기
            $(window).on("click", function (event) {
                if ($(event.target).is($scheduleModal)) {
                    $scheduleModal.fadeOut();
                }
                if ($(event.target).is($eventModal)) {
                    $eventModal.fadeOut();
                }
            });

            // 색출 버튼
            const scheduleTeamBtn = document.getElementById('schedule_team_btn'); // 팀 버튼
            const schedulePersonalBtn = document.getElementById('schedule_personal_btn'); // 개인 버튼
            const scheduleAllBtn = document.getElementById('schedule_all_btn'); // 전체 버튼

            scheduleTeamBtn.addEventListener('click', () => {
                document.querySelectorAll('.event-bar-team, .event-bar-personal, .event-bar-team-allday, .event-bar-personal-allday').forEach(div => {
                    div.style.display = 'none';
                });

                document.querySelectorAll('.event-bar-team').forEach(div => {
                    div.style.display = 'flex';
                });

                document.querySelectorAll('.event-bar-team-allday').forEach(div => {
                    div.style.display = 'block';
                });
            });

            schedulePersonalBtn.addEventListener('click', () => {
                document.querySelectorAll('.event-bar-team, .event-bar-personal, .event-bar-team-allday, .event-bar-personal-allday').forEach(div => {
                    div.style.display = 'none';
                });

                document.querySelectorAll('.event-bar-personal').forEach(div => {
                    div.style.display = 'flex';
                });

                document.querySelectorAll('.event-bar-personal-allday').forEach(div => {
                    div.style.display = 'block';
                });
            });

            scheduleAllBtn.addEventListener('click', () => {
                document.querySelectorAll('.event-bar-team, .event-bar-personal').forEach(div => {
                    div.style.display = 'flex';
                });

                document.querySelectorAll('.event-bar-personal-allday').forEach(div => {
                    div.style.display = 'block';
                });

                document.querySelectorAll('.event-bar-team-allday').forEach(div => {
                    div.style.display = 'block';
                });
            });

            // 체크박스 색상 변경
            document.querySelectorAll('.today-tasks input[type="checkbox"]').forEach((checkbox) => {
                checkbox.addEventListener('change', function () {
                    const taskContainer = this.closest('.today-tasks');
                    if (this.checked) {
                        taskContainer.style.backgroundColor = '#ababab';
                    } else {
                        taskContainer.style.backgroundColor = '#f8f9fa';
                    }
                });
            });

            // 날짜 관련 스크립트
            const currentMonthYear = document.getElementById('current-month-year');
            const calendarBody = document.querySelector('.calendar-body');
            const leftButton = document.getElementById('btn_left');
            const rightButton = document.getElementById('btn_right');

            const events = [
                { date: '2024-11-01', type: 'team-allday', title: '금융프로젝트', time: '오전 9:00~11:00', location: '강남역', memo: '김철수' },
                { date: '2024-11-04', type: 'team-allday', title: '점심 약속', time: '오후 12:00~13:00', location: '회사 식당', memo: '홍길동' },
                { date: '2024-11-06', type: 'team-allday', title: '프로젝트 발표', time: '오전 10:00~12:00', location: '회의실', memo: '팀원' },
                { date: '2024-11-06', type: 'personal', title: '영화보기', time: '오전 10:00~12:00', location: '영화관', person: '친구' },
                { date: '2024-11-11', type: 'personal', title: '점심약속', time: '오전 11:00~01:00', location: '영화관', memo: '혼자' },
                { date: '2024-11-20', type: 'personal-allday', title: '제주도 여행', time: '오전 8:00~오후 6:00', location: '제주도', memo: '여행팀' },
            ];

            let currentDate = new Date();

            function updateMonthYear() {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth() + 1;
                document.getElementById('current-month-year').textContent = `${year}년 ${month}월`;
            }

            function generateCalendar() {
                const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getDay(); // 현재 달 첫날 요일
                const lastDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate(); // 현재 달 마지막 날짜

                // 이전 달 마지막 날짜 계산
                const prevLastDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 0).getDate();

                calendarBody.innerHTML = '';
                let date = 1;
                let isLastDateDisplayed = false; // 마지막 날짜가 표시되었는지 확인

                for (let i = 0; i < 6; i++) { // 최대 6줄까지 출력
                    const row = document.createElement('tr');

                    for (let j = 0; j < 7; j++) {
                        const cell = document.createElement('td');
                        cell.classList.add('calendar-cell');

                        if (i === 0 && j < firstDay) {
                            // 이전 달 날짜 채우기
                            const prevDate = prevLastDate - (firstDay - j - 1);
                            cell.textContent = prevDate;
                            cell.classList.add('prev-month-cell');
                            cell.style.color = '#aaaaaa';
                            cell.style.backgroundColor = '#f0f0f0';
                        } else if (date <= lastDate) {
                            // 현재 달 날짜
                            const currentFormattedDate = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                            cell.innerHTML = `<div class="calendar-date">${date}</div>`;

                            const dayEvents = events.filter(event => event.date === currentFormattedDate);
                            dayEvents.forEach(event => {
                                const dotClass = event.type.includes('personal') ? 'event-dot-personal' : 'event-dot-team';
                                cell.innerHTML += `
                    <div class="event-bar-${event.type}" data-title="${event.title}" data-date="${event.date}" data-time="${event.time}" data-location="${event.location}" ${event.memo ? `data-memo="${event.memo}"` : ''}>
                        <span class="${dotClass}"></span>${event.title}
                    </div>`;
                            });

                            if (date === lastDate) {
                                isLastDateDisplayed = true; // 마지막 날짜가 표시됨
                            }

                            date++;
                        } else {
                            // 다음 달 날짜 채우기
                            const nextDate = date - lastDate;
                            cell.textContent = nextDate;
                            cell.classList.add('next-month-cell');
                            cell.style.color = '#aaaaaa';
                            cell.style.backgroundColor = '#f0f0f0';
                            date++;
                        }

                        row.appendChild(cell);
                    }

                    calendarBody.appendChild(row);

                    // 마지막 날짜가 표시되었고, 5줄 내에 출력이 완료되었으면 루프 종료
                    if (isLastDateDisplayed && i === 4) {
                        break;
                    }
                }
            }

            leftButton.addEventListener('click', function () {
                currentDate.setMonth(currentDate.getMonth() - 1);
                updateMonthYear();
                generateCalendar();
            });

            rightButton.addEventListener('click', function () {
                currentDate.setMonth(currentDate.getMonth() + 1);
                updateMonthYear();
                generateCalendar();
            });

            updateMonthYear();
            generateCalendar();

            document.querySelectorAll('.select-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    if (this.checked) {
                        document.querySelectorAll('.select-checkbox').forEach(otherCheckbox => {
                            if (otherCheckbox !== this) {
                                otherCheckbox.checked = false;
                            }
                        });
                    }
                });
            });
        });
    </script>




</div>
</body>

</html>