<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">
<meta name="_csrf" content="CSRF_TOKEN_VALUE">
<meta name="_csrf_header" content="X-CSRF-TOKEN">
<meta name="user_id" th:attr="content=${user_id}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê³ ê° ì´ë²¤íŠ¸ ê´€ë¦¬</title>
    <link rel="stylesheet" th:href="@{/css/schedule/customer.css}">
</head>

<body>
<div layout:fragment="content" class="content">
    <div class="container1">
        <div class="content1">
            <div class="calendar-container">
                <div class="calendar-header">
                    <h2>
                        <button id="btn_left">&lt;</button>
                        <span id="current-month-year"></span>
                        <button id="btn_right">&gt;</button>
                    </h2>
                    <div class="button-container">
                        <button id="schedule_all_btn">ì „ì²´</button>
                        <button id="birthday_btn">ìƒì¼</button>
                        <button id="finish_btn">ë§Œê¸°</button>
                    </div>
                </div>
                <table class="calendar-table">
                    <thead>
                    <tr>
                        <th id="sun">ì¼</th>
                        <th>ì›”</th>
                        <th>í™”</th>
                        <th>ìˆ˜</th>
                        <th>ëª©</th>
                        <th>ê¸ˆ</th>
                        <th id="sat">í† </th>
                    </tr>
                    </thead>
                    <tbody class="calendar-body">
                    <!-- JavaScriptë¡œ ë‚ ì§œ ìƒì„± -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="today_task">
            <div class="header-container">
                <h3 class="task-header">
                    <button id="prev-day-btn">&lt;</button>
                    <img th:src="@{/css/schedule/img/task_img.png}" alt="Task">
                    <span id="today-date"></span>
                    <button id="next-day-btn">&gt;</button>
                </h3>
                <button class="task_add">
                    <img id="task_add_btn" src="/css/schedule/img/add.png" alt="Add">
                </button>
            </div>
            <div class="today-cls-list"></div>
        </div>

    </div>


    <div class="event-card" style="display:none;">
        <span class="close-event">&times;</span>
        <div class="card-header">
            <h2 class="event-title"></h2>
            <div class="card-actions">
                <button class="delete-btn"><img id="delete_btn" th:src="@{/css/schedule/img/delete.png}" alt="Delete"></button>
                <button><img id="email_img" th:src="@{/css/schedule/img/email.png}" alt="Mail"></button>
            </div>
        </div>
        <div class="card-details">
            <div>
                <img th:src="@{/css/schedule/img/time.png}" alt="time">
                <span class="event-time"></span> <!-- ì¢…ë£Œ ë‚ ì§œ í‘œì‹œ -->
            </div>
            <div>
                <img th:src="@{/css/schedule/img/memo.png}" alt="memo">
                <span class="event-memo"></span> <!-- dsgn_ds_ty_cd í‘œì‹œ -->
            </div>
        </div>
    </div>


    <div class="schedule_detail" style="display: none;">
        <div class="scheduler-container">
            <h1>ìƒë‹´ ì¼ì • ë“±ë¡</h1>
            <div class="date-display">
                <button id="prev-day">&lt;</button>
                <span id="current-date"></span>
                <button id="next-day">&gt;</button>
            </div>
            <div class="scheduler">
                <span class="close">&times;</span>
                <div class="row">
                    <select class="time-select" id="time-select"></select>
                    <input type="text" class="task-title" placeholder="Enter title...">
                    <input type="text" class="location-input" placeholder="Enter location...">
                    <div class="checkboxes">
                        <label><input type="checkbox" class="select-checkbox" id="customer" checked> ê³ ê°</label>
                    </div>
                </div>
                <div class="details">
                    <textarea class="details-input" placeholder="Enter detailed information..."></textarea>
                </div>
                <input type="submit" id="submit_btn" value="ë“±ë¡">
            </div>
        </div>
    </div>


    <!-- JavaScript -->
    <script th:inline="javascript">
        $(document).ready(function () {
            const customerScheduleList = /*[[${customerScheduleList}]]*/ [];
            console.log("Customer Schedule List:", customerScheduleList);

            let scheduleList = [];
            let addedBirthdayIds = new Set(); // ìƒì¼ ë°ì´í„° ì¤‘ë³µ í™•ì¸ìš© Set
            let addedMaturityIds = new Set(); // ë§Œê¸° ë°ì´í„° ì¤‘ë³µ í™•ì¸ìš© Set
            let currentFilter = 'all'; // í˜„ì¬ í•„í„° ìƒíƒœ ('all', 'birthday', 'maturity')
            let currentDate = new Date(); // í˜„ì¬ ë‚ ì§œ ê°ì²´

            // ë°ì´í„° í”Œë˜íŠ¼(flatten): customerBirthdayDTOì™€ customerMtrDtDTO ë°ì´í„° ì¶”ì¶œ
            customerScheduleList.forEach(schedule => {
                if (schedule.customerBirthdayDTO) {
                    schedule.customerBirthdayDTO.forEach(birthday => {
                        if (!addedBirthdayIds.has(birthday.cust_id)) {
                            scheduleList.push({
                                type: "birthday",
                                date: birthday.cust_birthday, // MM-DD í˜•ì‹
                                name: birthday.cust_nm,
                            });
                            addedBirthdayIds.add(birthday.cust_id);
                        }
                    });
                }
                if (schedule.customerMtrDtDTO) {
                    schedule.customerMtrDtDTO.forEach(maturity => {
                        if (!addedMaturityIds.has(maturity.dsgn_sn)) {
                            scheduleList.push({
                                type: "maturity",
                                date: maturity.dpst_mtr_dt.split('-').slice(1).join('-'), // MM-DD í˜•ì‹
                                name: maturity.cust_nm,
                                dsgn_ds_ty_cd: maturity.dsgn_ds_ty_cd,
                            });
                            addedMaturityIds.add(maturity.dsgn_sn);
                        }
                    });
                }
            });

            console.log("Flattened Schedule List:", scheduleList);

            // ìº˜ë¦°ë” ìƒì„± í•¨ìˆ˜
            function generateCalendar() {
                const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getDay();
                const lastDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
                const prevLastDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 0).getDate();

                const today = new Date();
                const todayYear = today.getFullYear();
                const todayMonth = today.getMonth();
                const todayDate = today.getDate();

                const isCurrentMonth = currentDate.getFullYear() === todayYear && currentDate.getMonth() === todayMonth;

                $('.calendar-body').html('');
                let date = 1;

                for (let i = 0; i < 6; i++) {
                    const row = document.createElement('tr');
                    for (let j = 0; j < 7; j++) {
                        const cell = document.createElement('td');
                        cell.classList.add('calendar-cell');

                        if (i === 0 && j < firstDay) {
                            cell.textContent = prevLastDate - (firstDay - j - 1);
                            cell.classList.add('prev-month-cell');
                            cell.style.color = '#aaaaaa';
                            cell.style.backgroundColor = '#f0f0f0';
                        } else if (date <= lastDate) {
                            const formattedDate = `${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                            cell.innerHTML = `<div class="calendar-date">${date}</div>`;
                            cell.dataset.date = formattedDate; // MM-DD í˜•ì‹ ì €ì¥

                            if (isCurrentMonth && date === todayDate) {
                                const calendarDateDiv = cell.querySelector('.calendar-date');
                                calendarDateDiv.style.backgroundColor = '#CC0000';
                                calendarDateDiv.style.color = '#ffffff';
                                calendarDateDiv.style.width = '30px';
                                calendarDateDiv.style.height = '30px';
                                calendarDateDiv.style.display = 'flex';
                                calendarDateDiv.style.justifyContent = 'center';
                                calendarDateDiv.style.alignItems = 'center';
                                calendarDateDiv.style.borderRadius = '50%';
                            }

                            date++;
                        } else {
                            cell.textContent = date - lastDate;
                            cell.classList.add('next-month-cell');
                            cell.style.color = '#aaaaaa';
                            cell.style.backgroundColor = '#f0f0f0';
                            date++;
                        }

                        row.appendChild(cell);
                    }
                    $('.calendar-body').append(row);
                    if (date > lastDate) break;
                }

                renderEvents(scheduleList); // ì´ë²¤íŠ¸ ë Œë”ë§
                applyFilter(currentFilter); // í˜„ì¬ í•„í„° ìƒíƒœ ì ìš©
            }

            // í•„í„° ì ìš© í•¨ìˆ˜
            function applyFilter(filter) {
                if (filter === 'all') {
                    $('.event-bar-birthday, .event-bar-maturity').show();
                } else if (filter === 'birthday') {
                    $('.event-bar-birthday').show();
                    $('.event-bar-maturity').hide();
                } else if (filter === 'maturity') {
                    $('.event-bar-maturity').show();
                    $('.event-bar-birthday').hide();
                }
            }

            // ì´ë²¤íŠ¸ ë Œë”ë§ í•¨ìˆ˜
            function renderEvents(events) {
                const today = new Date();
                const todayDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

                $('.calendar-body .calendar-cell').each(function () {
                    const cellDate = $(this).data('date'); // ìº˜ë¦°ë” ì…€ì˜ ë‚ ì§œ (MM-DD í˜•ì‹)
                    if (!cellDate) return;

                    const dayEvents = events.filter(event => {
                        const eventFullDate = `${currentDate.getFullYear()}-${cellDate}`;
                        return event.date === cellDate;
                    });

                    $(this).find('.event-bar-birthday, .event-bar-maturity').remove();

                    dayEvents.slice(0, 3).forEach(event => {
                        const emoji = event.type === "birthday" ? 'ğŸ‚' : 'ğŸ“…';
    const eventClass = event.type === "birthday" ? 'event-bar-birthday' : 'event-bar-maturity';

   const eventFullDate = `${currentDate.getFullYear()}-${event.date}`; // ì´ë²¤íŠ¸ì˜ ì „ì²´ ë‚ ì§œ
    const eventDate = new Date(eventFullDate); // ì´ë²¤íŠ¸ ë‚ ì§œ ê°ì²´ ìƒì„±
    const today = new Date();
   const isPastEvent = eventDate < today.setHours(0, 0, 0, 0); // í˜„ì¬ ë‚ ì§œì™€ ë¹„êµí•´ ê³¼ê±°ì¸ì§€ í™•ì¸

    const $eventElement = $(`
        <div class="${eventClass} event-item ${isPastEvent ? 'past-event' : ''}"
             data-date="${event.date}"
             data-dsgn-ds-ty-cd="${event.dsgn_ds_ty_cd || ''}">
            <span class="event-emoji">${emoji}</span>
            <span class="event-text">${event.name} ê³ ê°ë‹˜</span>
        </div>
    `);
$(document).on('click', '.task_etc', function (event) {
    event.stopPropagation();

    // í´ë¦­í•œ Task ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const $taskContainer = $(this).closest('.today-tasks');
    const calendarSn = $taskContainer.data('calendar-sn'); // ë¨¼ì € calendarSnì„ ê°€ì ¸ì˜´

    if (!calendarSn) {
        console.error('Calendar SN is missing!');
        alert('ì´ ì¼ì •ì˜ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    // ëª¨ë‹¬ì— calendar-sn ê°’ ì„¤ì •
    $('.event-card').attr('data-calendar-sn', calendarSn);

    const taskDetails = {
        title: $taskContainer.find('#task_text p').text(),
        time: $taskContainer.data('date'), // ì‹œì‘ ì‹œê°„ í‘œì‹œ
        detail: $taskContainer.data('detail') || 'ì„¸ë¶€ ë‚´ìš© ì—†ìŒ', // dsgn_ds_ty_cd ë°ì´í„°
    };

    // ëª¨ë‹¬ì— Task ì •ë³´ ì±„ìš°ê¸°
    const $eventCard = $('.event-card');
    $eventCard.find('.event-title').text(taskDetails.title || 'ì œëª© ì—†ìŒ');
    $eventCard.find('.event-time').text(taskDetails.time || 'ì‹œê°„ ì •ë³´ ì—†ìŒ');
    $eventCard.find('.event-memo').text(taskDetails.detail);

    // ëª¨ë‹¬ í‘œì‹œ
    $eventCard.css({
        display: 'block',
        position: 'absolute',
        top: `${event.pageY + 10}px`,
        left: `${event.pageX -280}px`,
        zIndex: 1000,
    }).fadeIn();
});

// ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
$(document).on('click', '.close-event', function () {
    $('.event-card').fadeOut();
});

    $(this).append($eventElement);
                    });
                });
            }

            // ëª¨ë‹¬ì°½ ì—´ê¸°
            $('.calendar-body').on('click', '.event-bar-maturity', function (event) {
    event.stopPropagation();
    const customerName = $(this).find('.event-text').text();
    const maturityDate = $(this).data('date');
    const dsgnDsTyCd = $(this).data('dsgn-ds-ty-cd');
console.log("dsgnDsTyCd ê°’:", dsgnDsTyCd);
    // dsgnDsTyCd ê°’ì— ë”°ë¼ ì¶œë ¥ í…ìŠ¤íŠ¸ ì„¤ì •
    let dsgnTypeText;
    switch (String(dsgnDsTyCd)) {
        case '1':
            dsgnTypeText = "ì ê¸ˆ";
            break;
        case '2':
            dsgnTypeText = "ëª©ëˆ";
            break;
        case '3':
            dsgnTypeText = "ì˜ˆê¸ˆ";
            break;
        case '4':
            dsgnTypeText = "ëŒ€ì¶œ";
            break;
        default:
            dsgnTypeText = "ì•Œ ìˆ˜ ì—†ìŒ";
    }

    // ëª¨ë‹¬ì°½ì— ë°ì´í„° ì‚½ì…
    $('.event-card .event-title').text(`ê³ ê° : ${customerName}`);
    $('.event-card .event-time').text(`ì¢…ë£Œ ë‚ ì§œ : ${maturityDate}`);
    $('.event-card .event-memo').text(`ê°€ì… ìƒí’ˆ : ${dsgnTypeText}`);

    // í´ë¦­ ìœ„ì¹˜ì— ëª¨ë‹¬ì°½ í‘œì‹œ
    const clickX = event.pageX;
    const clickY = event.pageY;

    $('.event-card').css({
        display: 'block',
        top: clickY + 'px',
        left: clickX + 'px',
        position: 'absolute',
        transform: 'translate(-50%, 5%)'
    }).fadeIn();
});

            // ëª¨ë‹¬ì°½ ë‹«ê¸°
            $('.event-card .close-event').on('click', function () {
                $('.event-card').fadeOut();
            });

            // í•„í„° ë²„íŠ¼ ì´ë²¤íŠ¸
            $('#schedule_all_btn').on('click', function () {
                currentFilter = 'all';
                applyFilter(currentFilter);
            });

            $('#birthday_btn').on('click', function () {
                currentFilter = 'birthday';
                applyFilter(currentFilter);
            });

            $('#finish_btn').on('click', function () {
                currentFilter = 'maturity';
                applyFilter(currentFilter);
            });

            // ë‹¬ë ¥ ì´ë™ ë²„íŠ¼ ì´ë²¤íŠ¸
            $('#btn_left').on('click', function () {
                currentDate.setMonth(currentDate.getMonth() - 1);
                updateMonthYear();
                generateCalendar();
            });

            $('#btn_right').on('click', function () {
                currentDate.setMonth(currentDate.getMonth() + 1);
                updateMonthYear();
                generateCalendar();
            });

            // ì›” ë° ì—°ë„ ì—…ë°ì´íŠ¸
            function updateMonthYear() {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth() + 1;
                $('#current-month-year').text(`${year}ë…„ ${month}ì›”`);
            }

            // ì´ˆê¸°í™”
            updateMonthYear();
            generateCalendar();
        });


$(document).ready(function () {
    const customerScheduleList = /*[[${customerScheduleList}]]*/ []; // ì„œë²„ì—ì„œ ë°›ì€ ì¼ì • ë°ì´í„°
    const user_id = /*[[${user_id}]]*/ ''; // í˜„ì¬ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ID
    let currentDate = new Date(); // í˜„ì¬ ë‚ ì§œ ê°ì²´

    // ë‚ ì§œ í˜•ì‹ í¬ë§· í•¨ìˆ˜ (YYYY-MM-DD)
    function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // ë‚ ì§œ í˜•ì‹ í¬ë§· í•¨ìˆ˜ (ì›”, ì¼, ìš”ì¼)
    function formatDateWithDay(date) {
        const daysOfWeek = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
        const dayOfWeek = daysOfWeek[date.getDay()];
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${month}ì›” ${day}ì¼ (${dayOfWeek})`;
    }

    // ì˜¤ëŠ˜ ë‚ ì§œ ì¶œë ¥ í•¨ìˆ˜ (today-date: ì›”, ì¼, ìš”ì¼ í˜•ì‹)
    function updateTodayDateDisplay() {
        const formattedDate = formatDateWithDay(currentDate);
        $('#today-date').text(formattedDate); // today-dateì— ì¶œë ¥
    }

    // í˜„ì¬ ë‚ ì§œ ì¶œë ¥ í•¨ìˆ˜ (current-date: YYYY-MM-DD í˜•ì‹)
    function updateCurrentDateDisplay() {
        const formattedDate = formatDate(currentDate);
        $('#current-date').text(formattedDate); // current-dateì— ì¶œë ¥
        $('#current-date').data('current-date', formattedDate); // ë°ì´í„° ì†ì„±ë„ ì—…ë°ì´íŠ¸
    }

    // ìƒë‹´ ì¼ì • ë Œë”ë§ í•¨ìˆ˜
function renderTodayTasks(scheduleList) {
    const todayFormatted = formatDate(currentDate); // í˜„ì¬ ë‚ ì§œë¥¼ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ë³€í™˜
    const $todayTaskContainer = $('.today_task .today-cls-list');
    $todayTaskContainer.empty(); // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”

    const todayEvents = scheduleList.filter(event => {
        const eventDate = event.calendar_event_bgn_date.split(' ')[0]; // YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ë³€í™˜
        return (
            eventDate === todayFormatted && // ë‚ ì§œ ë¹„êµ
            event.user_id === user_id &&   // í˜„ì¬ ì‚¬ìš©ì IDì™€ ì¼ì¹˜í•˜ëŠ” ì¼ì •
            event.calendar_type === '3'   // calendar_typeì´ '3'ì¸ì§€ í™•ì¸
        );
    });

    // ì¼ì •ì´ ì—†ëŠ” ê²½ìš° ì²˜ë¦¬
    if (todayEvents.length === 0) {
        $todayTaskContainer.append('<p>ì˜¤ëŠ˜ ìƒë‹´ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>');
        return;
    }

    // ì¼ì • ë Œë”ë§
    todayEvents.forEach(event => {
        const time = event.calendar_event_bgn_date.split(' ')[1].slice(0, 5); // HH:mm í˜•ì‹ ì¶”ì¶œ
        const isChecked = event.task_checked_val ? 'checked' : ''; // task_checked_valì— ë”°ë¼ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ê²°ì •
        const backgroundColor = event.task_checked_val ? '#ababab' : '#f8f9fa'; // ì²´í¬ ì—¬ë¶€ì— ë”°ë¼ ë°°ê²½ìƒ‰ ì„¤ì •

        const $taskElement = `
            <div class="today-tasks"
                data-calendar-sn="${event.calendar_sn}"
                data-date="${event.calendar_event_bgn_date || ''}"
                data-location="${event.calendar_event_location || ''}"
                data-detail="${event.calendar_event_detail || ''}"
                style="background-color: ${backgroundColor};"> <!-- ë°°ê²½ìƒ‰ ì ìš© -->
                <label><strong>&middot; ${time}</strong></label>
                <button class="delete-task">
                    <img id="delete" src="/css/schedule/img/delete.png" alt="Delete">
                </button>
                <button class="task_etc">
                    <img id="task_etc_btn" src="/css/schedule/img/memo.png" alt="memo">
                </button>
                <div id="task_text">
                    <p>${event.calendar_event_title || 'ì œëª© ì—†ìŒ'}</p>
                    <input type="checkbox" ${isChecked}> <!-- ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë°˜ì˜ -->
                </div>
            </div>
        `;
        $todayTaskContainer.append($taskElement);
    });
}

    // ìƒë‹´ ì¼ì • ì‚­ì œ
    $(document).on('click', '.delete-task', function (event) {
        event.stopPropagation();
        const $taskContainer = $(this).closest('.today-tasks');
        const calendarSn = $taskContainer.data('calendar-sn');

        if (!calendarSn) {
            console.error('Calendar SN is missing!');
            return;
        }

        if (!confirm('ì •ë§ë¡œ ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        $.ajax({
            type: 'POST',
            url: '/schedule/personal/delete-task',
            contentType: 'application/json',
            data: JSON.stringify({ calendar_sn: calendarSn }),
            beforeSend: function (xhr) {
                const csrfHeader = $('meta[name="_csrf_header"]').attr('content');
                const csrfToken = $('meta[name="_csrf"]').attr('content');
                xhr.setRequestHeader(csrfHeader, csrfToken);
            },
            success: function () {
                $taskContainer.fadeOut(300, function () {
                    $(this).remove();
                });
                console.log('Task deleted successfully.');
            },
            error: function (xhr) {
                console.error('Failed to delete task:', xhr.responseText);
                alert('ì¼ì • ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        });
    });

    // ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë³€ê²½ ì´ë²¤íŠ¸
    $(document).on('change', '.today-tasks input[type="checkbox"]', function () {
        const $taskContainer = $(this).closest('.today-tasks');
        const calendarSn = $taskContainer.data('calendar-sn');
        const isChecked = $(this).is(':checked');

        $taskContainer.css('background-color', isChecked ? '#ababab' : '#f8f9fa');

        $.ajax({
            type: 'POST',
            url: '/schedule/customer/update-checkbox',
            contentType: 'application/json',
            data: JSON.stringify({
                calendar_sn: calendarSn,
                task_checked_val: isChecked
            }),
            beforeSend: function (xhr) {
                const csrfHeader = $('meta[name="_csrf_header"]').attr('content');
                const csrfToken = $('meta[name="_csrf"]').attr('content');
                xhr.setRequestHeader(csrfHeader, csrfToken);
            },
            success: function () {
                console.log('Checkbox state updated successfully:', calendarSn, 'Checked:', isChecked);
            },
            error: function (xhr) {
                console.error('Failed to update checkbox state:', xhr.responseText);
                alert('ìƒíƒœ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        });
    });
$(document).on('click', '.delete-btn', function (event) {
    event.stopPropagation(); // ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€

    // ëª¨ë‹¬ì—ì„œ ì‚­ì œí•  ë°ì´í„° ì‹ë³„ì(calendar-sn) ê°€ì ¸ì˜¤ê¸°
    const $eventModal = $('.event-card:visible'); // í˜„ì¬ ë³´ì´ëŠ” ëª¨ë‹¬ë§Œ ì„ íƒ
    const calendarSn = $eventModal.attr('data-calendar-sn'); // data ì†ì„±ì—ì„œ calendar-sn ì¶”ì¶œ

    if (!calendarSn) {
        console.error('Calendar SN is missing!');
        alert('ì‚­ì œí•  ì¼ì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    // ì‚­ì œ í™•ì¸
    if (!confirm('ì •ë§ë¡œ ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    // AJAX ìš”ì²­ìœ¼ë¡œ ì¼ì • ì‚­ì œ
    $.ajax({
        type: 'POST',
        url: '/schedule/personal/delete-task', // ì‚­ì œ API ì—”ë“œí¬ì¸íŠ¸
        contentType: 'application/json',
        data: JSON.stringify({ calendar_sn: calendarSn }), // calendar_sn ë°ì´í„°ë¥¼ JSONìœ¼ë¡œ ì „ë‹¬
        beforeSend: function (xhr) {
            const csrfHeader = $('meta[name="_csrf_header"]').attr('content'); // CSRF í—¤ë” ì´ë¦„
            const csrfToken = $('meta[name="_csrf"]').attr('content'); // CSRF í† í° ê°’
            xhr.setRequestHeader(csrfHeader, csrfToken); // CSRF í—¤ë” ì„¤ì •
        },
        success: function () {
            // ëª¨ë‹¬ ë‹«ê¸° ë° í•´ë‹¹ ì¼ì • ì œê±°
            $eventModal.fadeOut();
            $(`.today-tasks[data-calendar-sn="${calendarSn}"]`).remove();
            console.log('Event deleted successfully.');
        },
        error: function (xhr) {
            console.error('Failed to delete event:', xhr.responseText);
            alert('ì¼ì • ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    });
});

    // ì¼ì • ë“±ë¡ ëª¨ë‹¬ ì—´ê¸°
    $(document).on('click', '.task_add', function (event) {
        event.stopPropagation();
        const clickX = event.pageX;
        const clickY = event.pageY;

        $('.schedule_detail').css({
            display: 'block',
            position: 'absolute',
            top: `${clickY + 10}px`,
            left: `${clickX + 30}px`,
            transform: 'translateX(-90%)',
            zIndex: 1000
        }).fadeIn();

        updateCurrentDateDisplay(); // í˜„ì¬ ë‚ ì§œ ì—…ë°ì´íŠ¸
    });

    // ì¼ì • ë“±ë¡ ëª¨ë‹¬ ë‹«ê¸°
    $(document).on('click', '.close', function () {
        $('.schedule_detail').fadeOut();
    });

    // ì¼ì • ë“±ë¡
    $(document).on('click', '#submit_btn', function () {
        const modalDate = $('#current-date').text();
        const selectedTime = $('#time-select').val();

        if (!modalDate || !selectedTime) {
            alert('ë‚ ì§œì™€ ì‹œê°„ì„ ì„ íƒí•˜ì„¸ìš”.');
            return;
        }

        const combinedDateTime = `${modalDate} ${selectedTime}:00`;
        const eventTitle = $('.task-title').val();
        const eventLocation = $('.location-input').val();
        const eventDetail = $('.details-input').val();

        if (!eventTitle) {
            alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        const now = new Date();
        now.setHours(now.getHours() - 9);

        const createdAt = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;

        $.ajax({
            type: 'POST',
            url: '/schedule/customer/register',
            contentType: 'application/json',
            data: JSON.stringify({
                user_id: user_id,
                calendar_event_bgn_date: combinedDateTime,
                calendar_create_at: createdAt,
                calendar_event_title: eventTitle,
                calendar_event_location: eventLocation,
                calendar_event_detail: eventDetail,
                calendar_type: '3'
            }),
            beforeSend: function (xhr) {
                const csrfHeader = $('meta[name="_csrf_header"]').attr('content');
                const csrfToken = $('meta[name="_csrf"]').attr('content');
                xhr.setRequestHeader(csrfHeader, csrfToken);
            },
            success: function () {
                alert('ì¼ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                location.reload();
            },
            error: function (xhr) {
                console.error('ì¼ì • ì €ì¥ ì‹¤íŒ¨:', xhr.responseText);
                alert('ì¼ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        });
    });

    // ì´ì „/ë‹¤ìŒ ë²„íŠ¼ ì´ë²¤íŠ¸ (ëª¨ë‹¬ ë‚ ì§œ ë³€ê²½)
    $(document).on('click', '#prev-day', function () {
        currentDate.setDate(currentDate.getDate() - 1);
        updateCurrentDateDisplay(); // ëª¨ë‹¬ì˜ í˜„ì¬ ë‚ ì§œ ì—…ë°ì´íŠ¸
    });

    $(document).on('click', '#next-day', function () {
        currentDate.setDate(currentDate.getDate() + 1);
        updateCurrentDateDisplay(); // ëª¨ë‹¬ì˜ í˜„ì¬ ë‚ ì§œ ì—…ë°ì´íŠ¸
    });

    // ë©”ì¸ í™”ë©´ì˜ ì´ì „/ë‹¤ìŒ ë²„íŠ¼ (today-date ë° ì¼ì • ë³€ê²½)
    $(document).on('click', '#prev-day-btn', function () {
        currentDate.setDate(currentDate.getDate() - 1); // í˜„ì¬ ë‚ ì§œë¥¼ í•˜ë£¨ ì „ìœ¼ë¡œ ë³€ê²½
        updateTodayDateDisplay(); // today-date ì—…ë°ì´íŠ¸
        renderTodayTasks(customerScheduleList); // ìƒë‹´ ì¼ì • ë Œë”ë§
    });

    $(document).on('click', '#next-day-btn', function () {
        currentDate.setDate(currentDate.getDate() + 1); // í˜„ì¬ ë‚ ì§œë¥¼ í•˜ë£¨ í›„ë¡œ ë³€ê²½
        updateTodayDateDisplay(); // today-date ì—…ë°ì´íŠ¸
        renderTodayTasks(customerScheduleList); // ìƒë‹´ ì¼ì • ë Œë”ë§
    });

    // ì‹œê°„ ì„ íƒ ì´ˆê¸°í™”
    function initializeTimeSelect() {
        const $timeSelect = $('#time-select');
        for (let i = 0; i < 48; i++) {
            const hour = String(Math.floor(i / 2)).padStart(2, '0');
            const minute = i % 2 === 0 ? '00' : '30';
            $timeSelect.append(`<option value="${hour}:${minute}">${hour}:${minute}</option>`);
        }
    }

    initializeTimeSelect();
    updateTodayDateDisplay();
    updateCurrentDateDisplay();
    renderTodayTasks(customerScheduleList);
});


    </script>

</div>
</body>

</html>