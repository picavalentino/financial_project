<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">
<meta name="_csrf" content="CSRF_TOKEN_VALUE">
<meta name="_csrf_header" content="X-CSRF-TOKEN">
<meta name="user_id" th:attr="content=${user_id}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê³ ê° ì´ë²¤íŠ¸ ê´€ë¦¬</title>
    <link rel="stylesheet" th:href="@{/css/schedule/customer.css}">
</head>

<body>
<div layout:fragment="content" class="content">
    <div class="location">
        <a th:href="@{/main}"><i class="bi bi-house-door-fill"></i> Home</a>
        <a th:href="@{/schedule/customer}"> / í™œë™ ê´€ë¦¬</a>
        <span> / ê³ ê° ì´ë²¤íŠ¸ ê´€ë¦¬ </span>
    </div>
    <h1 class="title">ê³ ê° ì´ë²¤íŠ¸ ê´€ë¦¬</h1>
    <div class="container1">
        <div class="content1">
            <div class="calendar-container">
                <div class="calendar-header">
                    <h2>
                        <button id="btn_left">&lt;</button>
                        <span id="current-month-year"></span>
                        <button id="btn_right">&gt;</button>
                    </h2>
                    <div class="button-container">
                        <button id="schedule_all_btn">ì „ì²´</button>
                        <button id="birthday_btn">ìƒì¼</button>
                        <button id="finish_btn">ë§Œê¸°</button>
                    </div>
                </div>
                <table class="calendar-table">
                    <thead>
                    <tr>
                        <th id="sun">ì¼</th>
                        <th>ì›”</th>
                        <th>í™”</th>
                        <th>ìˆ˜</th>
                        <th>ëª©</th>
                        <th>ê¸ˆ</th>
                        <th id="sat">í† </th>
                    </tr>
                    </thead>
                    <tbody class="calendar-body">
                    <!-- JavaScriptë¡œ ë‚ ì§œ ìƒì„± -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="today_task">
            <div class="header-container">
                <h3 class="task-header">
                    <button id="prev-day-btn">&lt;</button>
                    <img th:src="@{/css/schedule/img/task_img.png}" alt="Task">
                    <span id="today-date"></span>
                    <button id="next-day-btn">&gt;</button>
                </h3>
                <button class="task_add">
                    <img id="task_add_btn" src="/css/schedule/img/add.png" alt="Add">
                </button>
            </div>
            <div class="today-cls-list"></div>
        </div>

    </div>


    <div class="event-card" style="display:none;">
        <span class="close-event">&times;</span>
        <div class="card-header">
            <h2 class="event-title"></h2>
            <div class="card-actions">
                <button class="delete-btn"><img id="delete_btn" th:src="@{/css/schedule/img/delete.png}" alt="Delete"></button>
                <button><img id="email_img" th:src="@{/css/schedule/img/email.png}" alt="Mail"></button>
            </div>
        </div>
        <div class="card-details">
            <div>
                <img th:src="@{/css/schedule/img/time.png}" alt="time">
                <span class="event-time"></span> <!-- ì¢…ë£Œ ë‚ ì§œ í‘œì‹œ -->
            </div>
            <div>
                <img th:src="@{/css/schedule/img/memo.png}" alt="memo">
                <span class="event-memo"></span> <!-- dsgn_ds_ty_cd í‘œì‹œ -->
            </div>
        </div>
    </div>
    <div class="schedule_detail" style="display:none;">
        <div class="scheduler-container">
            <h1>ì¼ì • ìƒì„¸</h1>
            <div class="date-display">
                <button id="prev-day">&lt;</button>
                <span id="current-date"></span>
                <button id="next-day">&gt;</button>
            </div>
            <div class="scheduler">
                <span class="close">&times;</span>
                <div class="row">
                    <select class="time-select" id="time-select"></select>
                    <input type="text" class="task-title" placeholder="Enter title...">
                    <input type="text" class="location-input" placeholder="Enter location...">
                    <div class="checkboxes">
                        <label><input type="checkbox" class="select-checkbox" id="team-team"> íŒ€</label>
                        <label><input type="checkbox" class="select-checkbox" id="team-personal"> ê°œì¸</label>
                        <label><input type="checkbox" id="event-allday"> ì¢…ì¼</label>
                    </div>
                </div>
                <div class="details">
                    <textarea class="details-input" placeholder="Enter detailed information..."></textarea>
                </div>
                <input type="submit" id="submit_btn" value="ë“±ë¡">
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script th:inline="javascript">
        $(document).ready(function () {
            const customerScheduleList = /*[[${customerScheduleList}]]*/ [];
            console.log("Customer Schedule List:", customerScheduleList);

            let scheduleList = [];
            let addedBirthdayIds = new Set(); // ìƒì¼ ë°ì´í„° ì¤‘ë³µ í™•ì¸ìš© Set
            let addedMaturityIds = new Set(); // ë§Œê¸° ë°ì´í„° ì¤‘ë³µ í™•ì¸ìš© Set
            let currentFilter = 'all'; // í˜„ì¬ í•„í„° ìƒíƒœ ('all', 'birthday', 'maturity')
            let currentDate = new Date(); // í˜„ì¬ ë‚ ì§œ ê°ì²´

            // ë°ì´í„° í”Œë˜íŠ¼(flatten): customerBirthdayDTOì™€ customerMtrDtDTO ë°ì´í„° ì¶”ì¶œ
            customerScheduleList.forEach(schedule => {
                if (schedule.customerBirthdayDTO) {
                    schedule.customerBirthdayDTO.forEach(birthday => {
                        if (!addedBirthdayIds.has(birthday.cust_id)) {
                            scheduleList.push({
                                type: "birthday",
                                date: birthday.cust_birthday, // MM-DD í˜•ì‹
                                name: birthday.cust_nm,
                            });
                            addedBirthdayIds.add(birthday.cust_id);
                        }
                    });
                }
                if (schedule.customerMtrDtDTO) {
                    schedule.customerMtrDtDTO.forEach(maturity => {
                        if (!addedMaturityIds.has(maturity.dsgn_sn)) {
                            scheduleList.push({
                                type: "maturity",
                                date: maturity.dpst_mtr_dt.split('-').slice(1).join('-'), // MM-DD í˜•ì‹
                                name: maturity.cust_nm,
                                dsgn_ds_ty_cd: maturity.dsgn_ds_ty_cd,
                            });
                            addedMaturityIds.add(maturity.dsgn_sn);
                        }
                    });
                }
            });

            console.log("Flattened Schedule List:", scheduleList);

            // ìº˜ë¦°ë” ìƒì„± í•¨ìˆ˜
            function generateCalendar() {
                const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getDay();
                const lastDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
                const prevLastDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 0).getDate();

                const today = new Date();
                const todayYear = today.getFullYear();
                const todayMonth = today.getMonth();
                const todayDate = today.getDate();

                const isCurrentMonth = currentDate.getFullYear() === todayYear && currentDate.getMonth() === todayMonth;

                $('.calendar-body').html('');
                let date = 1;

                for (let i = 0; i < 6; i++) {
                    const row = document.createElement('tr');
                    for (let j = 0; j < 7; j++) {
                        const cell = document.createElement('td');
                        cell.classList.add('calendar-cell');

                        if (i === 0 && j < firstDay) {
                            cell.textContent = prevLastDate - (firstDay - j - 1);
                            cell.classList.add('prev-month-cell');
                            cell.style.color = '#aaaaaa';
                            cell.style.backgroundColor = '#f0f0f0';
                        } else if (date <= lastDate) {
                            const formattedDate = `${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                            cell.innerHTML = `<div class="calendar-date">${date}</div>`;
                            cell.dataset.date = formattedDate; // MM-DD í˜•ì‹ ì €ì¥

                            if (isCurrentMonth && date === todayDate) {
                                const calendarDateDiv = cell.querySelector('.calendar-date');
                                calendarDateDiv.style.backgroundColor = '#CC0000';
                                calendarDateDiv.style.color = '#ffffff';
                                calendarDateDiv.style.width = '30px';
                                calendarDateDiv.style.height = '30px';
                                calendarDateDiv.style.display = 'flex';
                                calendarDateDiv.style.justifyContent = 'center';
                                calendarDateDiv.style.alignItems = 'center';
                                calendarDateDiv.style.borderRadius = '50%';
                            }

                            date++;
                        } else {
                            cell.textContent = date - lastDate;
                            cell.classList.add('next-month-cell');
                            cell.style.color = '#aaaaaa';
                            cell.style.backgroundColor = '#f0f0f0';
                            date++;
                        }

                        row.appendChild(cell);
                    }
                    $('.calendar-body').append(row);
                    if (date > lastDate) break;
                }

                renderEvents(scheduleList); // ì´ë²¤íŠ¸ ë Œë”ë§
                applyFilter(currentFilter); // í˜„ì¬ í•„í„° ìƒíƒœ ì ìš©
            }

            // í•„í„° ì ìš© í•¨ìˆ˜
            function applyFilter(filter) {
                if (filter === 'all') {
                    $('.event-bar-birthday, .event-bar-maturity').show();
                } else if (filter === 'birthday') {
                    $('.event-bar-birthday').show();
                    $('.event-bar-maturity').hide();
                } else if (filter === 'maturity') {
                    $('.event-bar-maturity').show();
                    $('.event-bar-birthday').hide();
                }
            }

            // ì´ë²¤íŠ¸ ë Œë”ë§ í•¨ìˆ˜
            function renderEvents(events) {
                const today = new Date();
                const todayDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

                $('.calendar-body .calendar-cell').each(function () {
                    const cellDate = $(this).data('date'); // ìº˜ë¦°ë” ì…€ì˜ ë‚ ì§œ (MM-DD í˜•ì‹)
                    if (!cellDate) return;

                    const dayEvents = events.filter(event => {
                        const eventFullDate = `${currentDate.getFullYear()}-${cellDate}`;
                        return event.date === cellDate;
                    });

                    $(this).find('.event-bar-birthday, .event-bar-maturity').remove();

                    dayEvents.slice(0, 3).forEach(event => {
                        const emoji = event.type === "birthday" ? 'ğŸ‚' : 'ğŸ“…';
    const eventClass = event.type === "birthday" ? 'event-bar-birthday' : 'event-bar-maturity';

   const eventFullDate = `${currentDate.getFullYear()}-${event.date}`; // ì´ë²¤íŠ¸ì˜ ì „ì²´ ë‚ ì§œ
    const eventDate = new Date(eventFullDate); // ì´ë²¤íŠ¸ ë‚ ì§œ ê°ì²´ ìƒì„±
    const today = new Date();
   const isPastEvent = eventDate < today.setHours(0, 0, 0, 0); // í˜„ì¬ ë‚ ì§œì™€ ë¹„êµí•´ ê³¼ê±°ì¸ì§€ í™•ì¸

    const $eventElement = $(`
        <div class="${eventClass} event-item ${isPastEvent ? 'past-event' : ''}"
             data-date="${event.date}"
             data-dsgn-ds-ty-cd="${event.dsgn_ds_ty_cd || ''}">
            <span class="event-emoji">${emoji}</span>
            <span class="event-text">${event.name} ê³ ê°ë‹˜</span>
        </div>
    `);

    $(this).append($eventElement);
                    });
                });
            }

            // ëª¨ë‹¬ì°½ ì—´ê¸°
            $('.calendar-body').on('click', '.event-bar-maturity', function (event) {
    event.stopPropagation();
    const customerName = $(this).find('.event-text').text();
    const maturityDate = $(this).data('date');
    const dsgnDsTyCd = $(this).data('dsgn-ds-ty-cd');
console.log("dsgnDsTyCd ê°’:", dsgnDsTyCd);
    // dsgnDsTyCd ê°’ì— ë”°ë¼ ì¶œë ¥ í…ìŠ¤íŠ¸ ì„¤ì •
    let dsgnTypeText;
    switch (String(dsgnDsTyCd)) {
        case '1':
            dsgnTypeText = "ì ê¸ˆ";
            break;
        case '2':
            dsgnTypeText = "ëª©ëˆ";
            break;
        case '3':
            dsgnTypeText = "ì˜ˆê¸ˆ";
            break;
        case '4':
            dsgnTypeText = "ëŒ€ì¶œ";
            break;
        default:
            dsgnTypeText = "ì•Œ ìˆ˜ ì—†ìŒ";
    }

    // ëª¨ë‹¬ì°½ì— ë°ì´í„° ì‚½ì…
    $('.event-card .event-title').text(`ê³ ê° : ${customerName}`);
    $('.event-card .event-time').text(`ì¢…ë£Œ ë‚ ì§œ : ${maturityDate}`);
    $('.event-card .event-memo').text(`ê°€ì… ìƒí’ˆ : ${dsgnTypeText}`);

    // í´ë¦­ ìœ„ì¹˜ì— ëª¨ë‹¬ì°½ í‘œì‹œ
    const clickX = event.pageX;
    const clickY = event.pageY;

    $('.event-card').css({
        display: 'block',
        top: clickY + 'px',
        left: clickX + 'px',
        position: 'absolute',
        transform: 'translate(-50%, 5%)'
    }).fadeIn();
});

            // ëª¨ë‹¬ì°½ ë‹«ê¸°
            $('.event-card .close-event').on('click', function () {
                $('.event-card').fadeOut();
            });

            // í•„í„° ë²„íŠ¼ ì´ë²¤íŠ¸
            $('#schedule_all_btn').on('click', function () {
                currentFilter = 'all';
                applyFilter(currentFilter);
            });

            $('#birthday_btn').on('click', function () {
                currentFilter = 'birthday';
                applyFilter(currentFilter);
            });

            $('#finish_btn').on('click', function () {
                currentFilter = 'maturity';
                applyFilter(currentFilter);
            });

            // ë‹¬ë ¥ ì´ë™ ë²„íŠ¼ ì´ë²¤íŠ¸
            $('#btn_left').on('click', function () {
                currentDate.setMonth(currentDate.getMonth() - 1);
                updateMonthYear();
                generateCalendar();
            });

            $('#btn_right').on('click', function () {
                currentDate.setMonth(currentDate.getMonth() + 1);
                updateMonthYear();
                generateCalendar();
            });

            // ì›” ë° ì—°ë„ ì—…ë°ì´íŠ¸
            function updateMonthYear() {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth() + 1;
                $('#current-month-year').text(`${year}ë…„ ${month}ì›”`);
            }

            // ì´ˆê¸°í™”
            updateMonthYear();
            generateCalendar();
        });

$(document).ready(function () {
    const customerScheduleList = /*[[${customerScheduleList}]]*/ []; // ì„œë²„ì—ì„œ ë°›ì€ ì¼ì • ë°ì´í„°
    const user_id = /*[[${user_id}]]*/ ''; // í˜„ì¬ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ID
    let currentDate = new Date(); // í˜„ì¬ ë‚ ì§œ ê°ì²´

    // ë‚ ì§œ í˜•ì‹ í¬ë§· í•¨ìˆ˜ (ìš”ì¼ í¬í•¨)
    function formatDateWithDay(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const daysOfWeek = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ']; // ìš”ì¼ ë°°ì—´
        const dayOfWeek = daysOfWeek[date.getDay()]; // ìš”ì¼ ê°€ì ¸ì˜¤ê¸°
        return `${month}ì›”${day}ì¼ (${dayOfWeek})`;
    }

    // ë¬¸ìì—´ ë‚ ì§œë¥¼ JavaScript Date ê°ì²´ë¡œ ë³€í™˜
    function parseDate(dateString) {
        return new Date(dateString.replace(' ', 'T')); // '2024-11-30 00:00' -> '2024-11-30T00:00'
    }

    // ì˜¤ëŠ˜ ìƒë‹´ ì¼ì • ë Œë”ë§ í•¨ìˆ˜
    function renderTodayTasks(scheduleList) {
        const todayFormatted = formatDateWithDay(currentDate); // í˜„ì¬ ë‚ ì§œ í¬ë§·
        const $todayTaskContainer = $('.today_task .today-cls-list');
        $todayTaskContainer.empty(); // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”

        console.log("Current Date (Formatted):", todayFormatted);
        console.log("Customer Schedule List:", scheduleList);

        // ì˜¤ëŠ˜ì˜ ìƒë‹´ ì¼ì • í•„í„°ë§
        const todayEvents = scheduleList.filter(event => {
            const eventDate = formatDateWithDay(parseDate(event.calendar_event_bgn_date)); // ë‚ ì§œ ë¹„êµ
            return (
                eventDate === todayFormatted && // ë‚ ì§œê°€ ì˜¤ëŠ˜ì¸ì§€ í™•ì¸
                event.user_id === user_id &&   // user_idê°€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
                event.calendar_type === '3'   // calendar_typeì´ '3'ì¸ì§€ í™•ì¸
            );
        });

        console.log("Filtered Events:", todayEvents);

        // ì¼ì •ì´ ì—†ëŠ” ê²½ìš°
        if (todayEvents.length === 0) {
            $todayTaskContainer.append('<p>ì˜¤ëŠ˜ ìƒë‹´ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>');
            return;
        }

        // ì¼ì • ë Œë”ë§
             todayEvents.forEach(event => {
            const time = parseDate(event.calendar_event_bgn_date).toTimeString().substring(0, 5); // HH:mm í¬ë§·
            const $taskElement = $(`
                <div class="today-tasks" data-calendar-sn="${event.calendar_sn}">
                    <label><strong>&middot; ${time}</strong></label>
                    <button class="delete-task">
                        <img id="delete" src="/css/schedule/img/delete.png" alt="Delete">
                    </button>
                    <button class="task_etc">
                        <img id="task_etc_btn" src="/css/schedule/img/memo.png" alt="memo">
                    </button>

                    <div id="task_text">
                        <p>${event.calendar_event_title || 'ì œëª© ì—†ìŒ'}</p>
                    </div>
                </div>
            `);
            $todayTaskContainer.append($taskElement);
        });
    }

    // ëª¨ë‹¬ì°½ ì—´ê¸° í•¨ìˆ˜
    function openModal(eventData) {
        // ëª¨ë‹¬ì°½ ë°ì´í„° ì‚½ì…
        $('.schedule_detail #current-date').text(formatDateWithDay(parseDate(eventData.calendar_event_bgn_date)));
        $('.schedule_detail .task-title').val(eventData.calendar_event_title || '');
        $('.schedule_detail .location-input').val(eventData.calendar_event_location || '');
        $('.schedule_detail .details-input').val(eventData.calendar_event_detail || '');

        // ëª¨ë‹¬ì°½ í‘œì‹œ
        $('.schedule_detail').fadeIn();
    }

    // ëª¨ë‹¬ì°½ ë‹«ê¸° ì´ë²¤íŠ¸
    $('.schedule_detail .close').on('click', function () {
        $('.schedule_detail').fadeOut();
    });

    // ì˜¤ëŠ˜ì˜ ìƒë‹´ ì¼ì •ì—ì„œ task_add ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    $('.today_task').on('click', '.task_add', function (e) {
        e.stopPropagation(); // ë¶€ëª¨ ìš”ì†Œì˜ í´ë¦­ ì´ë²¤íŠ¸ ë°©ì§€
        const $task = $(this).closest('.today-tasks'); // í˜„ì¬ í´ë¦­í•œ ë²„íŠ¼ì˜ ë¶€ëª¨ ìš”ì†Œ
        const calendarSn = $task.data('calendar-sn'); // calendar_sn ê°’ ê°€ì ¸ì˜¤ê¸°
        const eventData = customerScheduleList.find(event => event.calendar_sn === calendarSn);

        if (eventData) {
            openModal(eventData); // ì„ íƒëœ ì¼ì • ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ëª¨ë‹¬ì°½ ì—´ê¸°
        } else {
            console.error('ì¼ì¹˜í•˜ëŠ” ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', calendarSn);
        }
    });

    // ë‚ ì§œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateTodayDate() {
        $('#today-date').text(formatDateWithDay(currentDate)); // ë‚ ì§œì™€ ìš”ì¼ì„ í•¨ê»˜ ì¶œë ¥
    }

    // ì´ì „ ë‚ ì§œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    $('#prev-day-btn').on('click', function () {
        currentDate.setDate(currentDate.getDate() - 1); // ë‚ ì§œ ê°ì†Œ
        updateTodayDate();
        renderTodayTasks(customerScheduleList); // ì—…ë°ì´íŠ¸ëœ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ì¼ì • ë Œë”ë§
    });

    // ë‹¤ìŒ ë‚ ì§œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    $('#next-day-btn').on('click', function () {
        currentDate.setDate(currentDate.getDate() + 1); // ë‚ ì§œ ì¦ê°€
        updateTodayDate();
        renderTodayTasks(customerScheduleList); // ì—…ë°ì´íŠ¸ëœ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ì¼ì • ë Œë”ë§
    });

    // ì´ˆê¸°í™” ì‘ì—…
    updateTodayDate(); // ì´ˆê¸° ë‚ ì§œ í‘œì‹œ
    renderTodayTasks(customerScheduleList); // ì´ˆê¸° ì¼ì • ë Œë”ë§
});
    </script>

</div>
</body>

</html>