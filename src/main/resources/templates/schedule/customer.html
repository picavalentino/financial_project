<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/layout}">
<meta name="_csrf" content="CSRF_TOKEN_VALUE">
<meta name="_csrf_header" content="X-CSRF-TOKEN">
<meta name="user_id" th:attr="content=${user_id}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>고객 이벤트 관리</title>
    <link rel="stylesheet" th:href="@{/css/schedule/customer.css}">
</head>

<body>
<div layout:fragment="content" class="content">
    <div class="container1">
        <div class="content1">
            <div class="calendar-container">
                <div class="calendar-header">
                    <h2>
                        <button id="btn_left">&lt;</button>
                        <span id="current-month-year"></span>
                        <button id="btn_right">&gt;</button>
                    </h2>
                    <div class="button-container">
                        <button id="schedule_all_btn">전체</button>
                        <button id="birthday_btn">생일</button>
                        <button id="finish_btn">만기</button>
                    </div>
                </div>
                <table class="calendar-table">
                    <thead>
                    <tr>
                        <th id="sun">일</th>
                        <th>월</th>
                        <th>화</th>
                        <th>수</th>
                        <th>목</th>
                        <th>금</th>
                        <th id="sat">토</th>
                    </tr>
                    </thead>
                    <tbody class="calendar-body">
                    <!-- JavaScript로 날짜 생성 -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="today_task">
            <h3>
                <button id="prev-day-btn">&lt;</button>
                <span id="today-date"></span>
                <button id="next-day-btn">&gt;</button>
            </h3>
            <div class="today-tasks-list"></div>
        </div>
    </div>

    <!-- JavaScript -->
    <script th:inline="javascript">
        $(document).ready(function () {
            const customerScheduleList = /*[[${customerScheduleList}]]*/ [];
            console.log("Customer Schedule List:", customerScheduleList);

            let scheduleList = [];
let addedIds = new Set(); // 추가된 cust_id를 추적하기 위한 Set

customerScheduleList.forEach(schedule => {
    // 생일 데이터 처리
    if (schedule.customerBirthdayDTO) {
        schedule.customerBirthdayDTO.forEach(birthday => {
            if (!addedIds.has(birthday.cust_id)) { // 중복되지 않은 경우만 추가
                scheduleList.push({
                    type: "birthday",
                    date: birthday.cust_birthday,
                    name: birthday.cust_nm,
                    id: birthday.cust_id, // 중복 확인을 위해 id 포함
                });
                addedIds.add(birthday.cust_id); // 추가된 id를 기록
            }
        });
    }

    // 만기 데이터 처리
    if (schedule.customerMtrDtDTO) {
        schedule.customerMtrDtDTO.forEach(maturity => {
            if (!addedIds.has(maturity.dsgn_sn)) { // 중복되지 않은 경우만 추가
                scheduleList.push({
                    type: "maturity",
                    date: maturity.dpst_mtr_dt.split('-').slice(1).join('-'), // MM-DD 형식으로 변환
                    name: maturity.cust_nm,
                    id: maturity.dsgn_sn, // 중복 확인을 위해 id 포함
                });
                addedIds.add(maturity.dsgn_sn); // 추가된 id를 기록
            }
        });
    }
});

            console.log("Flattened Schedule List:", scheduleList);

            let currentDate = new Date();

            // 캘린더 생성 함수
            function generateCalendar() {
                const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getDay();
                const lastDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
                const prevLastDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 0).getDate();

                $('.calendar-body').html('');
                let date = 1;

                for (let i = 0; i < 6; i++) {
                    const row = document.createElement('tr');
                    for (let j = 0; j < 7; j++) {
                        const cell = document.createElement('td');
                        cell.classList.add('calendar-cell');

                        if (i === 0 && j < firstDay) {
                            const prevDate = prevLastDate - (firstDay - j - 1);
                            cell.textContent = prevDate;
                            cell.classList.add('prev-month-cell');
                        } else if (date <= lastDate) {
                            const formattedDate = `${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                            cell.innerHTML = `<div class="calendar-date">${date}</div>`;
                            cell.dataset.date = formattedDate; // MM-DD 형식 저장
                            date++;
                        } else {
                            const nextDate = date - lastDate;
                            cell.textContent = nextDate;
                            cell.classList.add('next-month-cell');
                            date++;
                        }
                        row.appendChild(cell);
                    }
                    $('.calendar-body').append(row);
                    if (date > lastDate) break;
                }

                renderEvents(scheduleList);
            }

            // 이벤트 렌더링 함수
            function renderEvents(events) {
                $('.calendar-body .calendar-cell').each(function () {
                    const cellDate = $(this).data('date'); // MM-DD 형식
                    if (!cellDate) return;

                    const dayEvents = events.filter(event => event.date === cellDate);

                    dayEvents.forEach(event => {
                        const eventClass = event.type === "birthday" ? 'event-bar-birthday' : 'event-bar-expiration';
                        const eventText = `${event.name} (${event.type === "birthday" ? "생일" : "만기"})`;

                        const $eventElement = $(`<div class="${eventClass}">${eventText}</div>`);
                        $(this).append($eventElement);
                    });
                });
            }

            // 월, 년 업데이트
            function updateMonthYear() {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth() + 1;
                $('#current-month-year').text(`${year}년 ${month}월`);
            }

            // 버튼 이벤트
            $('#btn_left').on('click', function () {
                currentDate.setMonth(currentDate.getMonth() - 1);
                updateMonthYear();
                generateCalendar();
            });

            $('#btn_right').on('click', function () {
                currentDate.setMonth(currentDate.getMonth() + 1);
                updateMonthYear();
                generateCalendar();
            });

            $('#schedule_all_btn').on('click', function () {
                renderEvents(scheduleList);
            });

            $('#birthday_btn').on('click', function () {
                const birthdayEvents = scheduleList.filter(event => event.type === "birthday");
                renderEvents(birthdayEvents);
            });

            $('#finish_btn').on('click', function () {
                const maturityEvents = scheduleList.filter(event => event.type === "maturity");
                renderEvents(maturityEvents);
            });

            // 초기화
            updateMonthYear();
            generateCalendar();
        });
    </script>
</div>
</body>
</html>
